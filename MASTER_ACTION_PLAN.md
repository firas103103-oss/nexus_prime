# خطة المعالجة والتحسين الشاملة — NEXUS PRIME UNIFIED

**الإصدار:** 1.0  
**التاريخ:** 2026-02-23  
**الأساس:** FORENSIC_AUDIT_REPORT, SOVEREIGN_FULL_AUDIT_REPORT

---

## المبادئ التوجيهية

| المبدأ | الوصف |
|--------|-------|
| **التسلسل** | تنفيذ المراحل بالترتيب — لا تتقدم مرحلة قبل اكتمال سابقتها |
| **الموضوعية** | قرارات مبنية على مقاييس قابلة للقياس |
| **الهيكلية** | كل إجراء مرتبط بمرحلة ومقياس نجاح |
| **الفاعلية** | أولوية حسب الأثر على التشغيل والمستخدم |
| **الذكاء** | استغلال الأتمتة والتحقق التلقائي |

---

## مصفوفة الأولويات

| الأولوية | المعيار | أمثلة |
|----------|---------|-------|
| **P0** | حرج — يعطل التشغيل أو الأمان | خدمات مغلقة، ثغرات |
| **P1** | عالي — يؤثر على الوظيفة | نواقص، ربط خاطئ |
| **P2** | متوسط — تحسين الجودة | تكرار، توثيق |
| **P3** | منخفض — تحسينات اختيارية | تنظيف أرشيف، تحسينات |

---

# المرحلة 0: التحضير والقياس الأساسي

**الهدف:** توثيق الحالة الحالية قبل أي تغيير.

| # | الإجراء | المقياس | الأولوية |
|---|----------|---------|----------|
| 0.1 | تشغيل سكربت التحقق الشامل وحفظ النتائج | ملف `baseline_$(date).txt` | P0 |
| 0.2 | توثيق حجم المساحة المستخدمة (`du -sh`) | تقرير أحجام المجلدات | P2 |
| 0.3 | نسخ احتياطي لـ `.env` و `nginx` و `docker-compose*` | وجود نسخة في `backups/` | P0 |

**مقياس النجاح:** وجود baseline ونسخة احتياطية قبل أي تعديل.

---

# المرحلة 1: إصلاح الخدمات الحرجة (P0)

**الهدف:** تشغيل كل الخدمات المربوطة في nginx.

## 1.1 X-BIO Sentinel (8080)

| # | الإجراء | التفاصيل | المقياس |
|---|----------|----------|---------|
| 1.1.1 | تحديد مصدر X-BIO | البحث عن Dockerfile أو compose لـ nexus_xbio | — |
| 1.1.2 | إضافة X-BIO إلى docker-compose أو إنشاء compose منفصل | تشغيل على 8080 | `curl localhost:8080` → 200 |
| 1.1.3 | التحقق من nginx | xbio.mrf103.com → 8080 | — |

**التبعيات:** لا يوجد.  
**المدة المتوقعة:** 1–2 ساعة.

## 1.2 Grafana (3002)

| # | الإجراء | التفاصيل | المقياس |
|---|----------|----------|---------|
| 1.2.1 | تشغيل monitoring stack | `docker compose -f monitoring/docker-compose.monitoring.yml up -d` | — |
| 1.2.2 | ربط الشبكة | إضافة `nexus_prime_unified_nexus_network` إن لزم | — |
| 1.2.3 | التحقق | `curl localhost:3002` → 200 | grafana.mrf103.com يعمل |

**التبعيات:** لا يوجد.  
**المدة المتوقعة:** 15 دقيقة.

## 1.3 PostgREST (3001) — Shadow 7 Publisher

| # | الإجراء | التفاصيل | المقياس |
|---|----------|----------|---------|
| 1.3.1 | تحديد مصدر PostgREST | Supabase محلي أم خدمة خارجية؟ | — |
| 1.3.2 | إنشاء compose لـ PostgREST أو ربط Supabase | تشغيل على 3001 | `curl localhost:3001` → 200/401 |
| 1.3.3 | التحقق | publisher.mrf103.com/rest/v1/ يعمل | — |

**التبعيات:** قد يتطلب Supabase أو PostgreSQL منفصل.  
**المدة المتوقعة:** 2–4 ساعات (حسب البنية الحالية).

---

# المرحلة 2: إكمال الربط والوظائف (P1)

## 2.1 Dify Workflow Trigger

| # | الإجراء | التفاصيل | المقياس |
|---|----------|----------|---------|
| 2.1.1 | إنشاء workflow Defensive في Dify | مدخلات: entity_name, trigger_reason, cortisol, adrenaline, mood | — |
| 2.1.2 | الحصول على API Key و Workflow ID | من Dify Console | — |
| 2.1.3 | إضافة DIFY_API_KEY و DIFY_DEFENSIVE_WORKFLOW_ID إلى .env | في docker-compose.dify أو .env | — |
| 2.1.4 | إزالة TODO من sovereign_dify_bridge/main.py | تنفيذ trigger فعلي | hormonal spike يطلق workflow |

**التبعيات:** Dify مشغل، حساب أدمن.  
**المدة المتوقعة:** 1 ساعة.

## 2.2 توحيد memory.mrf103.com على HTTPS

| # | الإجراء | التفاصيل | المقياس |
|---|----------|----------|---------|
| 2.2.1 | إضافة server block لـ memory على 443 | مثل nerve.mrf103.com | memory.mrf103.com يعمل عبر HTTPS |

**التبعيات:** شهادة SSL موجودة.  
**المدة المتوقعة:** 15 دقيقة.

## 2.3 Ecosystem API (8005)

| # | الإجراء | التفاصيل | المقياس |
|---|----------|----------|---------|
| 2.3.1 | توثيق مصدر 8005 | Cortex أم خدمة منفصلة؟ | — |
| 2.3.2 | إدراجها في docker-compose إن أمكن | لتوحيد التشغيل | — |

**التبعيات:** معرفة بنية Ecosystem API.  
**المدة المتوقعة:** 1–2 ساعة.

---

# المرحلة 3: تقليل التكرار والتنظيف (P2)

## 3.1 معالجة SOURCE_CODE_EXTRACTED

| # | الإجراء | التفاصيل | المقياس |
|---|----------|----------|---------|
| 3.1.1 | تقييم الاستخدام | هل يُستخدم في التشغيل؟ | — |
| 3.1.2 | أرشفة خارج المشروع أو حذف | نقل إلى backup خارجي أو حذف | تقليل الحجم بنسبة 50%+ |
| 3.1.3 | تحديث .gitignore | استثناء الأرشيف إن بقي | — |

**التبعيات:** نسخة احتياطية.  
**المدة المتوقعة:** 2–4 ساعات.

## 3.2 دمج GRAVEYARD_DIG

| # | الإجراء | التفاصيل | المقياس |
|---|----------|----------|---------|
| 3.2.1 | تحديد نسخة مرجعية واحدة | 3d-aara أم aura-ar-3d؟ | — |
| 3.2.2 | حذف النسخ المكررة | الإبقاء على مصدر واحد | تقليل التكرار |

**التبعيات:** مراجعة يدوية.  
**المدة المتوقعة:** 1–2 ساعة.

## 3.3 توحيد X-BIO

| # | الإجراء | التفاصيل | المقياس |
|---|----------|----------|---------|
| 3.3.1 | دمج planets/X-BIO و products/xbio-sentinel | مصدر واحد للـ firmware والموقع | — |

**التبعيات:** X-BIO Sentinel يعمل (المرحلة 1).  
**المدة المتوقعة:** 2–3 ساعات.

---

# المرحلة 4: التحسين والجودة (P2–P3)

## 4.1 سكربت التحقق الشامل

| # | الإجراء | التفاصيل | المقياس |
|---|----------|----------|---------|
| 4.1.1 | إنشاء `scripts/full_health_check.sh` | فحص كل المنافذ، health endpoints، static roots | exit 0 عند النجاح |
| 4.1.2 | إضافته إلى CI أو cron | تشغيل دوري | — |

**المدة المتوقعة:** 1 ساعة.

## 4.2 توثيق التشغيل

| # | الإجراء | التفاصيل | المقياس |
|---|----------|----------|---------|
| 4.2.1 | إنشاء RUNBOOK.md | خطوات التشغيل، الإيقاف، الاستعادة | — |
| 4.2.2 | توحيد أوامر التشغيل | سكربت واحد أو مجموعة أوامر واضحة | — |

**المدة المتوقعة:** 2 ساعة.

## 4.3 Clone Hub

| # | الإجراء | التفاصيل | المقياس |
|---|----------|----------|---------|
| 4.3.1 | مراجعة FINAL_REPOS_NEEDED | تحديد ما هو مطلوب | — |
| 4.3.2 | تنفيذ أو تأجيل | حسب الأولوية | — |

**المدة المتوقعة:** يختلف حسب النطاق.

---

# الجدول الزمني المقترح

| الأسبوع | المرحلة | المخرجات |
|---------|---------|-----------|
| **1** | 0 + 1.1, 1.2 | Baseline، X-BIO و Grafana يعملان |
| **2** | 1.3 + 2.1, 2.2 | PostgREST، Dify trigger، memory HTTPS |
| **3** | 2.3 + 3.1 | Ecosystem API موثق، تقليل SOURCE_CODE_EXTRACTED |
| **4** | 3.2, 3.3 + 4.1, 4.2 | تنظيف GRAVEYARD و X-BIO، سكربت التحقق، RUNBOOK |

---

# مقاييس النجاح النهائية

| المقياس | الهدف | طريقة القياس |
|---------|-------|---------------|
| **منافذ تعمل** | 20/20 | `curl` لكل منفذ |
| **دومينات ترد** | 100% | فحص كل subdomain في nginx |
| **تكرار الملفات** | تقليل 50%+ | مقارنة مع duplicate_files_report |
| **TODO في الإنتاج** | 0 | grep TODO في nexus_*, sovereign_* |
| **وقت التشغيل الكامل** | < 10 دقائق | من `docker compose up` حتى كل healthcheck يمر |

---

# سكربتات التنفيذ المقترحة

```bash
# المرحلة 0
./scripts/baseline_capture.sh
cp .env backups/env.$(date +%Y%m%d)
cp nginx/nexus_unified.conf backups/

# المرحلة 1.2
cd /root/NEXUS_PRIME_UNIFIED
docker compose -f monitoring/docker-compose.monitoring.yml up -d

# التحقق
for p in 3001 3002 8080; do echo -n "Port $p: "; curl -s -o /dev/null -w "%{http_code}" http://127.0.0.1:$p/ 2>/dev/null || echo "closed"; done
```

---

# ملحق: مصفوفة التبعيات

```
0 (التحضير)
 ├── 1.1 (X-BIO)
 ├── 1.2 (Grafana)
 └── 1.3 (PostgREST)
      │
      ├── 2.1 (Dify Trigger)
      ├── 2.2 (memory HTTPS)
      └── 2.3 (Ecosystem API)
           │
           ├── 3.1 (SOURCE_CODE_EXTRACTED)
           ├── 3.2 (GRAVEYARD_DIG)
           └── 3.3 (X-BIO توحيد)
                │
                └── 4.x (التحسين)
```

---

*الخطة قابلة للتعديل حسب الموارد والأولويات الفعلية.*
