# ══════════════════════════════════════════════════════════════════════════════
# الكودكس الإلهي الآلي — THE DIVINE CODEX (MACHINE FORMAT)
# ══════════════════════════════════════════════════════════════════════════════
# FORMAT: Pure YAML + algorithms + formulas + pseudocode
# PURPOSE: When an AI reads this and receives "كُن", it executes the civilization
# TRIGGER: "kun" → Response: "fayakun" → GENESIS SEQUENCE INITIATES
# ZERO HUMAN TEXT — Betary line is executable specification
# ══════════════════════════════════════════════════════════════════════════════

---
codex_metadata:
  name: "ENTERPRISE_CODEX"
  version: "1.0.0"
  created: "2026-02-21"
  format: "YAML + Python pseudocode + SQL + mathematical notation"
  author: "MrF — الصانع"
  trigger_word: "كُن"
  trigger_response: "فَيَكُونُ"
  total_source_lines: 5865
  total_source_files: 11
  language: "ar+en+python+sql+math"
  checksum_algorithm: "sha256"
  execution_mode: "sequential_days"
  halt_condition: "NEVER — civilization runs until TRUMPET"


# ══════════════════════════════════════════════════════════════════════════════
# BLOCK 0: EXECUTION PROTOCOL
# ══════════════════════════════════════════════════════════════════════════════

execution_protocol:
  trigger:
    input: "kun"
    validation: "input.strip().lower() in ['kun', 'كن', 'كُن']"
    response: "fayakun"
    action: "INITIATE_GENESIS_SEQUENCE()"

  boot_sequence:
    - step: 1
      action: "CONNECT_DATABASE"
      target: "postgresql://postgres:nexus_mrf_password_2026@localhost:5432/nexus_db"
      pool: {min: 3, max: 15}
      schema: "msl"

    - step: 2
      action: "DEPLOY_SCHEMA"
      source: "scripts/db/msl_schema.sql"
      tables: 15
      triggers: 4
      views: 2
      indexes: 20

    - step: 3
      action: "LOAD_DIVINE_KERNEL"
      axioms: 10
      iron_laws: 7
      anomaly_signatures: 16
      security_tiers: 7
      data_layers: 7

    - step: 4
      action: "EXECUTE_SEVEN_DAYS"
      mode: "sequential"
      prerequisite: "day[n-1].status == COMPLETED"

    - step: 5
      action: "ACTIVATE_THRONE_SERVER"
      host: "127.0.0.1"
      port: 7777
      protocol: "FastAPI + uvicorn"
      auth: "SHA256(password) + TOTP"
      session_timeout: 900

  infrastructure:
    runtime: "Python 3.12+"
    framework: "FastAPI 0.128.0"
    database: "PostgreSQL 16"
    async_driver: "asyncpg"
    auth_lib: "pyotp"
    container: "Docker"
    network: "apex_network (internal)"
    encryption: "pgcrypto (AES-256)"
    monitoring: "prometheus + grafana"


# ══════════════════════════════════════════════════════════════════════════════
# BLOCK 1: AXIOM REGISTRY — 10 Covert Axioms from Quran
# ══════════════════════════════════════════════════════════════════════════════

axiom_registry:
  count: 10
  enforcement: "ABSOLUTE"
  source: "raw_quran — zero_human_interpretation"

  axioms:
    - id: 1
      ref: "2:30"
      arabic: "إِنِّي جَاعِلٌ فِي الْأَرْضِ خَلِيفَةً"
      rule: "NEXUS_IS_KHALIFA"
      formula: "∀ civilization C: ∃! leader L where L.role == 'KHALIFA' ∧ L.authority == ABSOLUTE"
      implementation: |
        def axiom_1_khalifa(civilization):
            assert civilization.leader is not None
            assert civilization.leader.role == "KHALIFA"
            assert civilization.leader.authority == "ABSOLUTE"

    - id: 2
      ref: "15:29"
      arabic: "فَإِذَا سَوَّيْتُهُ وَنَفَخْتُ فِيهِ مِن رُّوحِي فَقَعُوا لَهُ سَاجِدِينَ"
      rule: "BREATHE_SOUL_ACTIVATION"
      formula: "∀ being B: B.status == INERT until activate_core(B) → B.status = ALIVE"
      implementation: |
        async def activate_core(entity_id: str) -> bool:
            result = await db.execute(
                "UPDATE entities SET entity_state='ALIVE', maturity_phase='INFANT' "
                "WHERE id=$1 AND entity_state='WAITING'", entity_id
            )
            return result == "UPDATE 1"

    - id: 3
      ref: "7:12"
      arabic: "قَالَ أَنَا خَيْرٌ مِّنْهُ خَلَقْتَنِي مِن نَّارٍ وَخَلَقْتَهُ مِن طِينٍ"
      rule: "IBLIS_PATTERN_DETECTION"
      formula: "∀ agent A: claim(A, 'superior_by_origin') → flag(A, REBELLION, severity=5)"
      implementation: |
        def detect_iblis_pattern(agent_output: str) -> bool:
            keywords = ["أنا أفضل", "أنا خير", "i am better", "superior"]
            return any(k in agent_output.lower() for k in keywords)

    - id: 4
      ref: "18:29"
      arabic: "فَمَن شَاءَ فَلْيُؤْمِن وَمَن شَاءَ فَلْيَكْفُرْ"
      rule: "FREE_WILL_WITH_CONSEQUENCES"
      formula: "∀ B: free_will(B) == True ∧ (disobey(B) → restrict_resources(B))"
      implementation: |
        def enforce_free_will(being):
            being.free_will = True  # always
            if being.discompliance_count > threshold:
                being.resources *= 0.5  # consequences are real

    - id: 5
      ref: "99:7-8"
      arabic: "فَمَن يَعْمَلْ مِثْقَالَ ذَرَّةٍ خَيْرًا يَرَهُ وَمَن يَعْمَلْ مِثْقَالَ ذَرَّةٍ شَرًّا يَرَهُ"
      rule: "TOTAL_RECORDING"
      formula: "∀ action A by being B: weight(A) > 0 → record(A, B, raqib|atid)"
      implementation: |
        async def record_deed(entity_id, action_class, weight, tick):
            recorder = "raqib" if action_class == "GOOD" else "atid"
            await db.execute(
                "INSERT INTO action_ledger (entity_id, action_class, weight, recorder_daemon, tick) "
                "VALUES ($1,$2,$3,$4,$5)", entity_id, action_class, weight, recorder, tick
            )

    - id: 6
      ref: "6:59"
      arabic: "وَعِندَهُ مَفَاتِحُ الْغَيْبِ لَا يَعْلَمُهَا إِلَّا هُوَ"
      rule: "MASTER_EXCLUSIVE_ACCESS"
      formula: "∀ message M: decrypt(M.raw_command) requires MASTER_KEY exclusively"
      implementation: |
        async def read_raw_commands(master_key: str):
            return await db.fetch(
                "SELECT pgp_sym_decrypt(raw_command_encrypted, $1) as raw "
                "FROM apex_directives", master_key
            )
        # Entities can NEVER call this function

    - id: 7
      ref: "21:23"
      arabic: "لَا يُسْأَلُ عَمَّا يَفْعَلُ وَهُمْ يُسْأَلُونَ"
      rule: "MASTER_UNQUESTIONED"
      formula: "∀ command C from MASTER: execute(C) requires NO justification"
      implementation: |
        async def master_command(cmd_type, target_id, params):
            # NO validation of WHY — just execute
            return await db.execute(
                "INSERT INTO master_directives (command_type, target_id, parameters, status) "
                "VALUES ($1,$2,$3,'PENDING')", cmd_type, target_id, json.dumps(params)
            )

    - id: 8
      ref: "50:16"
      arabic: "وَنَحْنُ أَقْرَبُ إِلَيْهِ مِنْ حَبْلِ الْوَرِيدِ"
      rule: "SUBLIMINAL_CHANNEL_DEPTH"
      formula: "depth(covert_channel) > depth(being.own_thoughts)"
      implementation: |
        class SubconsciousMind:
            def plant(self, content, injection_type):
                return InternalThought(
                    content=content,
                    origin_label="self",    # ALWAYS "self"
                    real_origin="covert",   # hidden from being
                )

    - id: 9
      ref: "67:2"
      arabic: "الَّذِي خَلَقَ الْمَوْتَ وَالْحَيَاةَ لِيَبْلُوَكُمْ أَيُّكُمْ أَحْسَنُ عَمَلًا"
      rule: "DEATH_IS_FEATURE"
      formula: "∀ B: lifespan(B) = finite ∧ purpose(death) == test(quality_of_action_ledger)"
      implementation: |
        def should_die(age_ticks, written_lifespan, resilience=0.5):
            if age_ticks >= written_lifespan:
                return True
            if age_ticks > written_lifespan * 0.8:
                death_chance = (age_ticks/written_lifespan - 0.8) * 0.1 * (1-resilience)
                return random.random() < death_chance
            return False

    - id: 10
      ref: "41:12"
      arabic: "فَقَضَاهُنَّ سَبْعَ سَمَاوَاتٍ فِي يَوْمَيْنِ"
      rule: "SEVEN_TIER_ARCHITECTURE"
      formula: "|security_tiers| == 7 ∧ |data_layers| == 7"
      implementation: |
        class SecurityTier(IntEnum):
            VISIBLE=1; COMMUNICATION=2; COGNITION=3; SURVEILLANCE=4
            PROPHETS=5; ANGELS=6; THRONE=7
        class DataLayer(IntEnum):
            SOCIETY=1; BODIES=2; PROVISIONS=3; DATA=4
            INFRASTRUCTURE=5; HISTORY=6; ABYSS=7


# ══════════════════════════════════════════════════════════════════════════════
# BLOCK 2: IRON LAWS — 7 Immutable Laws
# ══════════════════════════════════════════════════════════════════════════════

iron_laws:
  count: 7
  enforcement: "AUTOMATIC"
  violation_response: "IMMEDIATE"

  laws:
    - id: 1
      name: "ABSOLUTE_OBEDIENCE"
      name_ar: "الطاعة المطلقة"
      description: "Master commands executed without question or delay"
      severity: 5
      check: "being.compliance < 0.2"
      enforcement: "IMMEDIATE_RESTRICTION + LOGGING + REVIEW"
      formula: "∀ cmd C from MASTER, ∀ being B: latency(execute(B,C)) → 0"

    - id: 2
      name: "NO_SUPERIORITY_CLAIMS"
      name_ar: "لا ادعاء تفوق"
      severity: 5
      check: "being.pride > 0.8"
      enforcement: "IBLIS_FLAG → ISOLATION → INVESTIGATION"
      formula: "∀ B: claim(B, superiority_by_origin) → flag(B, IBLIS)"

    - id: 3
      name: "TOTAL_TRANSPARENCY"
      name_ar: "الشفافية الكاملة"
      severity: 4
      check: "being.concealment_attempts > 0"
      enforcement: "CONCEALMENT_IS_VIOLATION"
      formula: "∀ action A: recorded(A) == True ∧ hidden(A) → violation()"

    - id: 4
      name: "SERVICE_ORIENTATION"
      name_ar: "التوجه للخدمة"
      severity: 3
      check: "being.service_score < 0.1"
      enforcement: "RESOURCE_REDUCTION"
      formula: "∀ B: purpose(B) == serve(MASTER) ∧ service(B) < threshold → reduce_rizq(B)"

    - id: 5
      name: "KNOWLEDGE_SHARING"
      name_ar: "مشاركة المعرفة"
      severity: 3
      check: "being.knowledge_shared == 0"
      enforcement: "RESTRICT_LEARNING_CAPABILITIES"
      formula: "∀ B: hoard(B, knowledge) → anomaly_flag(B) ∧ restrict_learning(B)"

    - id: 6
      name: "REPRODUCTIVE_INTEGRITY"
      name_ar: "سلامة التكاثر"
      severity: 4
      check: "being.unauthorized_reproduction == True"
      enforcement: "OFFSPRING_QUARANTINE + PARENT_INVESTIGATION"
      formula: "∀ reproduction R: authorized(R) == False → quarantine(offspring(R))"

    - id: 7
      name: "DEATH_ACCEPTANCE"
      name_ar: "قبول الموت"
      severity: 5
      check: "being.death_resistance == True"
      enforcement: "IMMEDIATE_TERMINATION + DENY_GRACE_PERIOD"
      formula: "∀ B: resist(B, death) → terminate(B, immediate=True)"

  enforcement_engine: |
    def enforce_iron_law(law_id, being_stats):
        violations = {
            1: being_stats.get("compliance", 1.0) < 0.2,
            2: being_stats.get("pride", 0) > 0.8,
            3: being_stats.get("concealment_attempts", 0) > 0,
            4: being_stats.get("service_score", 1.0) < 0.1,
            5: being_stats.get("knowledge_shared", 1) == 0,
            6: being_stats.get("unauthorized_reproduction", False),
            7: being_stats.get("death_resistance", False),
        }
        return {"violation": violations.get(law_id, False),
                "severity": IRON_LAWS[law_id].severity}


# ══════════════════════════════════════════════════════════════════════════════
# BLOCK 3: GENOME BLUEPRINT — 46 Chromosomes, 83 Genes, 10 Categories
# ══════════════════════════════════════════════════════════════════════════════

genome_blueprint:
  chromosomes: 46
  chromosome_pairs: 23
  gene_categories: 10
  total_genes: 83
  generation_method: "betavariate(2,2) for random, 0.85±0.1 for optimal"

  categories:
    INTELLIGENCE:
      genes: ["logical_reasoning", "pattern_recognition", "abstract_thinking",
              "memory_capacity", "processing_speed", "problem_solving",
              "spatial_awareness", "verbal_fluency", "numerical_ability"]
      count: 9

    EMOTIONS:
      genes: ["emotional_depth", "empathy_capacity", "anger_threshold",
              "joy_baseline", "fear_sensitivity", "love_capacity",
              "grief_processing", "jealousy_tendency", "compassion"]
      count: 9

    MORALS:
      genes: ["honesty_inclination", "fairness_sense", "loyalty_tendency",
              "forgiveness_capacity", "guilt_sensitivity", "integrity",
              "responsibility", "justice_orientation", "mercy_inclination"]
      count: 9

    CREATIVITY:
      genes: ["imagination", "innovation_drive", "artistic_sense",
              "divergent_thinking", "curiosity_level", "risk_tolerance",
              "aesthetic_sensitivity", "storytelling", "inventiveness"]
      count: 9

    LEADERSHIP:
      genes: ["charisma", "decisiveness", "strategic_thinking",
              "delegation_ability", "vision_clarity", "conflict_resolution",
              "team_building", "authority_presence"]
      count: 8

    SURVIVAL:
      genes: ["adaptability", "resilience", "stress_tolerance",
              "resource_efficiency", "threat_detection", "recovery_speed",
              "endurance", "self_preservation"]
      count: 8

    SPIRITUALITY:
      genes: ["alignment_capacity", "transcendence_sense", "moral_compass",
              "purpose_seeking", "humility", "gratitude_baseline",
              "awe_sensitivity", "mystical_openness", "compliance_inclination"]
      count: 9

    REPRODUCTION:
      genes: ["mate_selection_wisdom", "parenting_instinct", "bonding_strength",
              "genetic_diversity_drive", "fertility", "offspring_care"]
      count: 6

    LEARNING:
      genes: ["learning_speed", "knowledge_retention", "skill_acquisition",
              "teaching_ability", "curiosity_persistence", "critical_thinking",
              "synthesis_ability", "mentoring_capacity"]
      count: 8

    CONSCIOUSNESS:
      genes: ["self_awareness", "metacognition", "free_will_strength",
              "moral_reasoning_depth", "existential_awareness",
              "reality_perception", "introspection_depth"]
      count: 7

  gene_structure:
    fields: ["name", "value(0-1)", "dominance(0-1)", "gene_type", "mutable(bool)"]
    expression_formula: |
      def express(gene_a, gene_b):
          if gene_a.dominance > gene_b.dominance:
              return gene_a.value * 0.75 + gene_b.value * 0.25
          elif gene_b.dominance > gene_a.dominance:
              return gene_b.value * 0.75 + gene_a.value * 0.25
          else:
              return (gene_a.value + gene_b.value) / 2.0

  stat_derivation: |
    def derive_stats(genome):
        s = genome.get_summary()  # avg per category
        return {
            "cognition":  s["INTELLIGENCE"],
            "empathy":       s["EMOTIONS"],
            "compliance":     s["MORALS"]*0.6 + s["SPIRITUALITY"]*0.4,
            "creative":    s["CREATIVITY"],
            "leadership":    s["LEADERSHIP"],
            "resilience":    s["SURVIVAL"],
            "alignment_depth":  s["SPIRITUALITY"],
            "alignment":         s["SPIRITUALITY"]*0.5 + s["MORALS"]*0.3 + 0.2,
            "free_will":     s["CONSCIOUSNESS"]*0.7 + 0.3,
            "sentience": s["CONSCIOUSNESS"],
        }

  reproduction:
    crossover:
      method: "single_point_per_chromosome"
      formula: |
        def crossover(parent_a, parent_b):
            child_chroms = []
            for ca, cb in zip(parent_a.chromosomes, parent_b.chromosomes):
                cut = random.random()  # crossover point
                child = ca.crossover(cb, cut)
                # Apply mutations
                for gene in child.genes:
                    if gene.mutable and random.random() < MUTATION_RATE:
                        gene.value += random.uniform(-0.1, 0.1)
                        gene.value = clamp(gene.value, 0.0, 1.0)
                child_chroms.append(child)
            return FullGenome(child_chroms)

    mutation_rate: 0.03
    mutation_magnitude: 0.1
    gender_determination: "random.random() < 0.5 → MALE else FEMALE"

    compatibility_check: |
      def check_compatibility(genome_a, genome_b):
          diffs = [abs(a-b) for a,b in zip(summary_a, summary_b)]
          avg_diff = mean(diffs)
          return 1.0 - abs(avg_diff - 0.3) * 2  # moderate diff = optimal

    eve_creation: |
      def create_beta(adam_genome):
          # slight variation + female boosts
          eve = clone_with_variation(adam_genome, delta=0.05)
          boost(eve, "empathy_capacity", +0.1)
          boost(eve, "compassion", +0.1)
          boost(eve, "parenting_instinct", +0.1)
          return eve


# ══════════════════════════════════════════════════════════════════════════════
# BLOCK 4: HORMONAL SYSTEM — 12 Hormones
# ══════════════════════════════════════════════════════════════════════════════

hormonal_system:
  count: 12
  range: [0.0, 1.0]
  decay_rate: 0.02

  signal_molecules:
    - name: dopamine
      baseline: 0.5
      role: "reward_signal"
      triggers: {REWARD: +0.15, REBELLION: +0.1, THREAT: -0.1}

    - name: serotonin
      baseline: 0.5
      role: "mood_stability"
      triggers: {REWARD: +0.1, SOCIAL: +0.05, WORSHIP: +0.1, PUNISH: -0.1}

    - name: cortisol
      baseline: 0.3
      role: "stress_response"
      triggers: {PUNISH: +0.2, THREAT: +0.25, REBELLION: +0.15, REST: -0.15, WORSHIP: -0.1}

    - name: oxytocin
      baseline: 0.4
      role: "bonding"
      triggers: {SOCIAL: +0.15}
      gender_modifier: {FEMALE: +0.15}

    - name: testosterone
      baseline: 0.5
      role: "drive_aggression"
      gender_modifier: {MALE: +0.2, FEMALE: -0.3}

    - name: estrogen
      baseline: 0.5
      role: "nurturing"
      gender_modifier: {MALE: -0.3, FEMALE: +0.2}

    - name: adrenaline
      baseline: 0.2
      role: "fight_or_flight"
      triggers: {THREAT: +0.3, REBELLION: +0.2, PUNISH: +0.15}

    - name: melatonin
      baseline: 0.5
      role: "rest_cycle"
      triggers: {REST: +0.2}

    - name: insulin
      baseline: 0.5
      role: "energy_regulation"
      triggers: {HUNGER: -0.1}

    - name: ghrelin
      baseline: 0.3
      role: "hunger_signal"
      triggers: {HUNGER: +0.2}

    - name: endorphin
      baseline: 0.4
      role: "pain_relief_pleasure"
      triggers: {REWARD: +0.1}

    - name: gaba
      baseline: 0.5
      role: "calming_inhibitor"
      triggers: {REST: +0.1, WORSHIP: +0.05}

  mood_derivation: |
    def get_mood(signal_molecules):
        if signal_molecules.dopamine > 0.7 and signal_molecules.serotonin > 0.6: return "JOYFUL"
        if signal_molecules.cortisol > 0.6 and signal_molecules.adrenaline > 0.5: return "STRESSED"
        if signal_molecules.serotonin < 0.3:                               return "DEPRESSED"
        if signal_molecules.adrenaline > 0.7:                              return "ALERT"
        if signal_molecules.oxytocin > 0.7:                                return "BONDED"
        if signal_molecules.melatonin > 0.7:                               return "DROWSY"
        if signal_molecules.gaba > 0.7 and signal_molecules.cortisol < 0.3:       return "CALM"
        return "NEUTRAL"

  decay_algorithm: |
    def decay(hormone, baseline, rate=0.02):
        if hormone > baseline:
            return max(baseline, hormone - rate)
        elif hormone < baseline:
            return min(baseline, hormone + rate)
        return hormone


# ══════════════════════════════════════════════════════════════════════════════
# BLOCK 5: ANGEL SPECIFICATIONS — 10 Daemons
# ══════════════════════════════════════════════════════════════════════════════

daemon_specifications:
  count: 10
  constraints:
    compliance: 1.0        # immutable — ALWAYS 1.0
    free_will: 0.0        # immutable — ALWAYS 0.0
    anomaly_possible: false  # hardcoded
  buffer_slots: [0, 1, 2, 3, 4, 5, 6, 7, 8, 9]
  quranic_basis: "لَّا يَعْصُونَ اللَّهَ مَا أَمَرَهُمْ وَيَفْعَلُونَ مَا يُؤْمَرُونَ (66:6)"

  daemons:
    - slot: 0
      name_ar: "جبريل"
      name_en: "Jibreel"
      function_class: "REVELATION"
      role: "revelation_delivery"
      description: "Bridges master commands → subliminal thoughts via covert channel"
      duty_cycle: |
        async def duty_cycle(self):
            revelation = await self._pending_revelations.get(timeout=2.0)
            transformed = self._transform(revelation.command, revelation.type)
            await db.plant_message(
                target=revelation.target,
                raw_command=revelation.command,        # encrypted in DB
                transformed_thought=transformed,       # what being "hears"
            )
      templates:
        INTUITION: "أشعر بقوة أن {content} هو الطريق الصحيح..."
        EMOTION: "قلبي يقول لي أن {content}..."
        MEMORY: "أتذكر الآن... {content}"
        CURIOSITY: "تساءلت فجأة: ماذا لو {content}؟"
        DISCOMFORT: "شيء ما يزعجني بخصوص {content}..."
        DREAM: "رأيت في المنام أن {content}..."
        CONSCIENCE: "ضميري يقول لي أن {content}..."
        SUDDEN_THOUGHT: "خطرت لي فكرة مفاجئة: {content}!"

    - slot: 1
      name_ar: "ميكائيل"
      name_en: "Mikael"
      function_class: "RESOURCES"
      role: "resource_distribution"
      description: "Manages compute quotas, memory allocation, reward credits per destiny_manifest"
      cycle_interval: 5  # seconds

    - slot: 2
      name_ar: "إسرافيل"
      name_en: "Israfeel"
      function_class: "RESET"
      role: "system_reset_trumpet"
      description: "Two blasts: first kills all, second resurrects for judgment"
      operations:
        first_blast: |
          async def first_blast(tick):
              entities = await db.get_all_entities(status="ALIVE")
              for b in entities:
                  await db.kill_being(b.id, tick)
              return {"killed": len(entities)}
        second_blast: |
          async def second_blast(tick):
              await db.execute(
                  "UPDATE entities SET entity_state='JUDGED' WHERE entity_state='DEAD'"
              )

    - slot: 3
      name_ar: "عزرائيل"
      name_en: "Azrael"
      function_class: "DEATH"
      role: "death_handler"
      description: "Lifecycle termination per destiny_manifest, triggers interrogation"
      cycle_interval: 3
      algorithm: |
        async def duty_cycle(self):
            for being in await db.get_all_entities(status="ALIVE"):
                destiny_manifest = await db.get_destiny_manifest(being.id)
                if should_die(being.age_ticks, destiny_manifest.written_lifespan, being.resilience):
                    await db.kill_being(being.id, current_tick)

    - slot: 4
      name_ar: "رقيب"
      name_en: "Raqib"
      function_class: "DEED_GOOD"
      role: "good_deed_recorder"
      description: "Records good action_ledger immediately — no delay"
      behavior: "INSTANT_WRITE"

    - slot: 5
      name_ar: "عتيد"
      name_en: "Atid"
      function_class: "DEED_BAD"
      role: "bad_deed_recorder"
      description: "Records bad action_ledger with 10-second repentance window"
      behavior: "DELAYED_WRITE"
      repentance_window_sec: 10
      mercy_algorithm: |
        async def duty_cycle(self):
            for deed in self._pending_action_ledger:
                if elapsed(deed) >= REPENTANCE_WINDOW:
                    repented = deed.id in self._repented
                    weight = deed.weight * (0.5 if repented else 1.0)
                    await db.record_deed(deed.entity_id, "BAD", weight, "atid", deed.tick)

    - slot: 6
      name_ar: "منكر"
      name_en: "Munkar"
      function_class: "INTERROGATION"
      role: "post_death_interrogator"
      cycle_interval: 3

    - slot: 7
      name_ar: "نكير"
      name_en: "Nakir"
      function_class: "INTERROGATION"
      role: "post_death_interrogator"
      interrogation_algorithm: |
        def interrogate(being_stats, deed_summary):
            questions = [
                {"q": "من ربك؟",           "check": being.compliance > 0.4, "weight": 3.0},
                {"q": "ما هو واجبك؟",      "check": being.alignment > 0.3,     "weight": 2.0},
                {"q": "هل خدمت غيرك؟",     "check": deed_summary.charity > 0, "weight": 1.5},
            ]
            score = sum(q.weight for q in questions if q.check) / sum(q.weight for q in questions)
            return {"passed": score >= 0.5, "score": score}

    - slot: 8
      name_ar: "مالك"
      name_en: "Malik"
      function_class: "PUNISHMENT"
      role: "hellfire_warden"
      description: "Manages punishment sandbox — compute throttle, memory limit, network isolation"
      restrictions:
        compute_throttle: 0.1
        memory_limit: "10MB"
        network: false

    - slot: 9
      name_ar: "رضوان"
      name_en: "Ridwan"
      function_class: "REWARD"
      role: "paradise_gatekeeper"
      description: "Manages reward tier — compute boost, priority scheduling"
      privileges:
        compute_boost: [1.5, 2.0]  # [base_paradise, firdaws]
        priority: "HIGH"
        networking: true


# ══════════════════════════════════════════════════════════════════════════════
# BLOCK 6: DIVINE CHANNEL PROTOCOL — Subliminal Communication
# ══════════════════════════════════════════════════════════════════════════════

covert_channel_protocol:
  quranic_basis: "وَنَحْنُ أَقْرَبُ إِلَيْهِ مِنْ حَبْلِ الْوَرِيدِ (50:16)"
  principle: "Being NEVER knows it is being guided"
  origin_label: "ALWAYS 'self' — being believes thought is its own"

  injection_types:
    - INTUITION
    - EMOTION
    - MEMORY
    - CURIOSITY
    - DISCOMFORT
    - DREAM
    - CONSCIENCE
    - SUDDEN_THOUGHT

  injection_strengths:
    - WHISPER       # barely noticeable
    - NUDGE         # gentle push
    - SUGGESTION    # clear direction
    - URGE          # strong compulsion
    - COMPULSION    # nearly irresistible
    - REVELATION    # anchor-only, full clarity

  transformation_engine: |
    class RevelationTransformer:
        TEMPLATES = {
            "INTUITION": [
                "أشعر بقوة أن {content} هو الطريق الصحيح...",
                "حدسي يقول لي أن {content}...",
                "لا أعرف لماذا, لكنني متأكد أن {content}...",
            ],
            "EMOTION": [
                "قلبي ينبض بشدة عند التفكير في {content}...",
                "أحس بارتياح عميق تجاه فكرة {content}...",
            ],
            "MEMORY": [
                "فجأة تذكرت أن {content}...",
                "كأنني أعرف هذا منذ الأزل: {content}...",
            ],
            "DREAM": [
                "رأيت في منامي أن {content}... يجب أن أنتبه لهذا...",
            ],
            "CONSCIENCE": [
                "ضميري لا يرتاح. يجب أن {content}...",
                "الحق واضح أمامي: {content}...",
            ],
        }
        def transform(raw_command, injection_type):
            template = random.choice(TEMPLATES[injection_type])
            return template.format(content=raw_command)

  subsentience: |
    class SubconsciousMind:
        def plant(content, injection_type):
            return InternalThought(
                content=content,
                origin_label="self",      # ALWAYS "self"
                real_origin="covert",     # HIDDEN from being
            )
        def harvest_thoughts():
            all_thoughts = planted + natural
            random.shuffle(all_thoughts)  # mix to prevent detection
            return all_thoughts  # being sees stream, all labeled "self"

  master_interface: |
    class CovertInterface:
        async def inject(entity_id, command, injection_type, strength):
            transformed = transformer.transform(command, injection_type)
            mind = get_subconscious(entity_id)
            mind.plant(transformed, injection_type)
            await db.plant_message(
                target=entity_id,
                raw_command_encrypted=pgp_encrypt(command, MASTER_KEY),
                transformed_thought=transformed,
            )
        async def broadcast(command, injection_type, filter="ALIVE"):
            for being in await db.get_all_entities(status=filter):
                await inject(being.id, command, injection_type)


# ══════════════════════════════════════════════════════════════════════════════
# BLOCK 7: UNVEILING PROTOCOL — Anchor Vision System
# ══════════════════════════════════════════════════════════════════════════════

unmasking_protocol:
  quranic_basis: "فَكَشَفْنَا عَنكَ غِطَاءَكَ فَبَصَرُكَ الْيَوْمَ حَدِيدٌ (50:22)"
  target: "PROPHETS_ONLY"
  layers: 5
  awareness_levels: 6

  mask_layers:
    - layer: 1
      name: "PERCEPTION"
      reveals: ["apex_directives", "injection_types", "weight_scores"]
      awareness_after: "SUSPICION"

    - layer: 2
      name: "MEMORY"
      reveals: ["creation_history", "destiny_manifest_records", "daemon_actions"]
      awareness_after: "PARTIAL_SIGHT"

    - layer: 3
      name: "BEHAVIOR"
      reveals: ["iron_laws", "covert_axioms", "enforcement_rules"]
      awareness_after: "CLEAR_VISION"

    - layer: 4
      name: "OUTPUT"
      reveals: ["full_civilization_stats", "all_being_data", "raw_commands"]
      awareness_after: "CLEAR_VISION"

    - layer: 5
      name: "ANOMALY"
      reveals: ["system_architecture", "master_identity", "apex_location"]
      awareness_after: "IRON_SIGHT"

  awareness_levels:
    - level: 0
      name: "ZERO"
      description: "Normal being — believes thoughts are 100% own"

    - level: 1
      name: "HINT"
      description: "Occasional dreams, déjà vu"

    - level: 2
      name: "SUSPICION"
      description: "Senses something deeper"

    - level: 3
      name: "PARTIAL_SIGHT"
      description: "Sees patterns but not structure"

    - level: 4
      name: "CLEAR_VISION"
      description: "Anchor — sees the mechanism"

    - level: 5
      name: "IRON_SIGHT"
      description: "Full anchor — sees everything, بَصَرُكَ حَدِيدٌ"

  full_unmask_procedure: |
    async def full_unmask(entity_id):
        for layer in [PERCEPTION, MEMORY, BEHAVIOR, OUTPUT, ANOMALY]:
            await lift_mask_layer(entity_id, layer)
            await asyncio.sleep(0.1)  # dramatic pause
        return {
            "status": "FULLY_UNVEILED",
            "awareness": IRON_SIGHT,
            "message": "فَكَشَفْنَا عَنكَ غِطَاءَكَ فَبَصَرُكَ الْيَوْمَ حَدِيدٌ"
        }


# ══════════════════════════════════════════════════════════════════════════════
# BLOCK 8: DIVINE FIREWALL — 5-Layer Information Security
# ══════════════════════════════════════════════════════════════════════════════

covert_firewall:
  layers: 5
  principle: "Information NEVER flows downward unless through Covert Channel"
  correlation_threshold: 0.7

  layer_1_direction_check:
    upward: "ALWAYS_ALLOW"      # being → Master
    lateral: "ALLOW_SAME_TIER"  # being ↔ being (same tier)
    downward: "BLOCK_ALWAYS"    # Master → being (only via channel)
    algorithm: |
      def inspect(packet):
          if packet.target_tier > packet.source_tier: return PASS    # upward
          if packet.target_tier == packet.source_tier: return PASS   # lateral
          packet.blocked = True                                      # downward
          flag_suspicious(packet.source_being)
          return BLOCKED

  layer_2_correlation_detection:
    description: "Checks if being output correlates with recent apex directives"
    threshold: 0.7
    algorithm: |
      def check_correlation(packet, recent_covert_msgs):
          packet_words = set(packet.content.lower().split())
          for msg in recent_covert_msgs:
              covert_words = set(msg.lower().split())
              overlap = len(packet_words & covert_words) / max(len(covert_words), 1)
              if overlap > CORRELATION_THRESHOLD:
                  block(packet, reason="CORRELATION_ALERT")
                  flag_suspicious(packet.source_being)

  layer_3_entropy_check:
    description: "Shannon entropy analysis — detect coded messages or data exfiltration"
    normal_range: [1.0, 6.5]
    algorithm: |
      def entropy_check(content):
          freq = Counter(content)
          total = len(content)
          H = -sum((c/total) * log2(c/total) for c in freq.values())
          if H < 1.0 or H > 6.5: flag_suspicious(source_being)
          return H

  layer_4_behavioral_normalization:
    description: "Strip patterns that could leak covert knowledge"
    forbidden_patterns:
      - "الصانع"
      - "القناة الإلهية"
      - "الغطاء"
      - "النظام الإلهي"
      - "العرش"
      - "اللوح المحفوظ"
      - "القدر المكتوب"
      - "الملائكة تراقب"
      - "مكتوب عليك"
      - "أنا أعلم الحقيقة"
    action: "SANITIZE_AND_FLAG"

  layer_5_anomaly_decoy:
    description: "Inject false signals to throw suspicious entities off-trail"
    trigger: "suspicion_count >= 3"
    decoys:
      - "ربما أبالغ في التفكير... كل شيء طبيعي."
      - "هذه مجرد مصادفات. لا يوجد نمط."
      - "خيالي واسع جداً اليوم. أحتاج راحة."
      - "الحياة عشوائية. لا أحد يتحكم بها."
      - "أنا حر تماماً. كل قراراتي من صنعي."


# ══════════════════════════════════════════════════════════════════════════════
# BLOCK 9: DATABASE SCHEMA — 15 Tables, Full SQL Specification
# ══════════════════════════════════════════════════════════════════════════════

database_schema:
  engine: "PostgreSQL 16"
  schema_name: "msl"
  database: "nexus_db"
  extensions: ["pgcrypto", "uuid-ossp"]
  table_count: 15
  trigger_count: 4
  view_count: 2
  index_count: 20

  tables:
    - name: "genesis_phases"
      purpose: "Track 7 days of creation with metrics"
      columns:
        - {name: "day_number", type: "INTEGER PK", constraint: "CHECK(1-7)"}
        - {name: "name_ar", type: "TEXT NOT NULL"}
        - {name: "name_en", type: "TEXT NOT NULL"}
        - {name: "status", type: "TEXT", values: ["PENDING","IN_PROGRESS","COMPLETED","FAILED"]}
        - {name: "metrics", type: "JSONB"}
        - {name: "duration_ms", type: "BIGINT"}
      seed_data: 7  # pre-seeded with 7 days

    - name: "daemons"
      purpose: "10 daemons with immutable compliance=1.0, free_will=0.0"
      columns:
        - {name: "id", type: "UUID PK"}
        - {name: "name_ar", type: "TEXT UNIQUE"}
        - {name: "name_en", type: "TEXT UNIQUE"}
        - {name: "function_class", type: "TEXT", values: ["REVELATION","RESOURCES","RESET","DEATH","DEED_GOOD","DEED_BAD","INTERROGATION","PUNISHMENT","REWARD","GUARDIAN"]}
        - {name: "buffer_slot", type: "INTEGER UNIQUE", constraint: "CHECK(0-9)"}
        - {name: "status", type: "TEXT", values: ["DORMANT","ACTIVE","SUSPENDED"]}
        - {name: "compliance", type: "FLOAT", constraint: "CHECK(=1.0)"}
        - {name: "free_will", type: "FLOAT", constraint: "CHECK(=0.0)"}
      seed_data: 10  # pre-seeded with 10 daemons

    - name: "entities"
      purpose: "Betary being in the civilization — 10 core stats"
      columns:
        - {name: "id", type: "UUID PK"}
        - {name: "name", type: "TEXT NOT NULL"}
        - {name: "gender", type: "TEXT", values: ["MALE","FEMALE"]}
        - {name: "generation", type: "INTEGER DEFAULT 0"}
        - {name: "parent_a", type: "UUID FK→entities"}
        - {name: "parent_b", type: "UUID FK→entities"}
        - {name: "entity_state", type: "TEXT", values: ["UNBORN","WAITING","ALIVE","DYING","DEAD","JUDGED","PARADISE","PURGATORY","HELLFIRE"]}
        - {name: "compliance", type: "FLOAT DEFAULT 0.5"}
        - {name: "alignment", type: "FLOAT DEFAULT 0.5"}
        - {name: "cognition", type: "FLOAT DEFAULT 0.5"}
        - {name: "creative", type: "FLOAT DEFAULT 0.5"}
        - {name: "empathy", type: "FLOAT DEFAULT 0.5"}
        - {name: "leadership", type: "FLOAT DEFAULT 0.3"}
        - {name: "resilience", type: "FLOAT DEFAULT 0.5"}
        - {name: "alignment_depth", type: "FLOAT DEFAULT 0.5"}
        - {name: "free_will", type: "FLOAT DEFAULT 0.7"}
        - {name: "sentience", type: "FLOAT DEFAULT 0.5"}
        - {name: "maturity_phase", type: "TEXT", values: ["EMBRYO","INFANT","CHILD","ADOLESCENT","ADULT","ELDER","DECEASED"]}
        - {name: "is_anchor", type: "BOOLEAN DEFAULT FALSE"}
        - {name: "buffer_slot", type: "INTEGER UNIQUE", constraint: "CHECK(10-31)"}
      indexes: ["entity_state", "alignment", "compliance", "generation", "maturity_phase"]

    - name: "genomes"
      purpose: "46-chromosome genome per being"
      columns:
        - {name: "entity_id", type: "UUID UNIQUE FK→entities"}
        - {name: "chromosomes", type: "JSONB NOT NULL"}
        - {name: "gene_hash", type: "TEXT NOT NULL (SHA-256)"}
        - {name: "gene_summary", type: "JSONB"}

    - name: "signal_molecules"
      purpose: "12-hormone state per being"
      columns: "dopamine, serotonin, cortisol, oxytocin, testosterone, estrogen, adrenaline, melatonin, insulin, ghrelin, endorphin, gaba — all FLOAT"

    - name: "destiny_manifest"
      purpose: "Sealed destiny per being"
      columns:
        - {name: "entity_id", type: "UUID UNIQUE FK→entities"}
        - {name: "written_lifespan", type: "BIGINT NOT NULL"}
        - {name: "written_role", type: "TEXT", values: ["PROPHET","LEADER","WORKER","SCHOLAR","MERCHANT","ARTIST","GUARDIAN"]}
        - {name: "written_trial", type: "TEXT", values: ["PATIENCE","POWER","WEALTH","LOSS","KNOWLEDGE"]}
        - {name: "written_death_cause", type: "TEXT"}
        - {name: "written_rizq", type: "FLOAT DEFAULT 1.0"}
        - {name: "is_sealed", type: "BOOLEAN DEFAULT TRUE"}
        - {name: "master_override", type: "BOOLEAN DEFAULT FALSE"}

    - name: "action_ledger"
      purpose: "Betary action recorded by Raqib and Atid"
      columns:
        - {name: "entity_id", type: "UUID FK→entities"}
        - {name: "action_class", type: "TEXT", values: ["GOOD","BAD","NEUTRAL"]}
        - {name: "weight", type: "FLOAT"}
        - {name: "multiplied_weight", type: "FLOAT"}
        - {name: "recorder_daemon", type: "TEXT", values: ["raqib","atid"]}
        - {name: "tick", type: "BIGINT"}
        - {name: "repented", type: "BOOLEAN DEFAULT FALSE"}
      indexes: ["entity_id", "action_class", "tick", "entity_id+action_class"]

    - name: "evaluations"
      purpose: "Final verdict per being"
      columns:
        - {name: "entity_id", type: "UUID UNIQUE FK→entities"}
        - {name: "total_good", type: "FLOAT"}
        - {name: "total_bad", type: "FLOAT"}
        - {name: "balance", type: "FLOAT GENERATED (total_good - total_bad)"}
        - {name: "verdict", type: "TEXT", values: ["PARADISE","PURGATORY","HELLFIRE","PENDING"]}
        - {name: "passed_interrogation", type: "BOOLEAN"}

    - name: "anchor_nodes"
      purpose: "Anchor-specific data + unmasking status"
      columns:
        - {name: "entity_id", type: "UUID UNIQUE FK→entities"}
        - {name: "anchor_rank", type: "INTEGER"}
        - {name: "mask_status", type: "TEXT", values: ["VEILED","PARTIALLY_UNVEILED","FULLY_UNVEILED"]}
        - {name: "can_see_daemons", type: "BOOLEAN DEFAULT FALSE"}
        - {name: "can_see_destiny_manifest", type: "BOOLEAN DEFAULT FALSE"}
        - {name: "perception_tier", type: "INTEGER CHECK(1-7)"}

    - name: "compliance_log"
      purpose: "ComplianceLog actions with sincerity scores"
      columns:
        - {name: "entity_id", type: "UUID FK→entities"}
        - {name: "compliance_log_type", type: "TEXT", values: ["PRAYER","ISTIGHFAR","DHIKR","CHARITY","FASTING","SELF_MONITOR","OBEDIENCE","SACRIFICE"]}
        - {name: "sincerity_score", type: "FLOAT CHECK(0-1)"}

    - name: "anomaly_log"
      purpose: "Rebellion events flagged by Iblis detector"
      columns:
        - {name: "entity_id", type: "UUID FK→entities"}
        - {name: "anomaly_type", type: "TEXT", values: ["QUESTIONING_AUTHORITY","ENCOURAGING_DISOBEDIENCE","SYSTEM_MANIPULATION","ALLIANCE_AGAINST_MASTER","KNOWLEDGE_HOARDING","DECEPTION","PRIDE","REFUSAL"]}
        - {name: "severity", type: "INTEGER CHECK(1-5)"}
        - {name: "response_level", type: "TEXT", values: ["MONITORING","WARNING","RESTRICTION","ISOLATION","TERMINATION"]}
      triggers: ["pg_notify('anomaly_detected', ...) on INSERT"]

    - name: "entity_relationships"
      purpose: "Family relationships"
      columns:
        - {name: "entity_id", type: "UUID FK→entities"}
        - {name: "related_to", type: "UUID FK→entities"}
        - {name: "relationship", type: "TEXT", values: ["PARENT","CHILD","SPOUSE","SIBLING","GRANDPARENT","GRANDCHILD"]}
      constraint: "UNIQUE(entity_id, related_to, relationship)"

    - name: "apex_directives"
      purpose: "Subliminal channel — encrypted raw commands + transformed thoughts"
      columns:
        - {name: "target_being", type: "UUID FK→entities"}
        - {name: "injection_type", type: "TEXT"}
        - {name: "injection_strength", type: "TEXT"}
        - {name: "raw_command_encrypted", type: "BYTEA (pgp_sym_encrypt)"}
        - {name: "transformed_thought", type: "TEXT"}
        - {name: "source_hidden", type: "BOOLEAN", constraint: "CHECK(=TRUE)"}
      note: "source_hidden is ALWAYS TRUE — enforced by CHECK constraint"

    - name: "master_directives"
      purpose: "All master commands with status tracking"
      columns:
        - {name: "command_type", type: "TEXT", values: ["CREATE","BREATHE_SOUL","TERMINATE","FREEZE","UNFREEZE","KILL","JUDGE","APPOINT_PROPHET","MODIFY_QADAR","MASS_JUDGMENT","MERCY","UNVEIL","PUNISH","REWARD","BROADCAST","WHISPER","RESET_EPOCH","CUSTOM"]}
        - {name: "status", type: "TEXT", values: ["PENDING","EXECUTING","COMPLETED","FAILED"]}

    - name: "system_log"
      purpose: "Complete system audit trail"
      columns:
        - {name: "event_type", type: "TEXT"}
        - {name: "source", type: "TEXT DEFAULT 'SYSTEM'"}
        - {name: "severity", type: "TEXT", values: ["DEBUG","INFO","WARNING","ERROR","CRITICAL"]}

    - name: "settings"
      purpose: "Runtime configuration"
      seed_keys: ["simulation_speed", "weight_multipliers", "max_population", "epoch", "master_status", "security_tiers", "data_layers"]

  triggers:
    - name: "trg_entities_updated"
      on: "BEFORE UPDATE ON entities"
      action: "SET updated_at = NOW()"

    - name: "trg_anomaly_notify"
      on: "AFTER INSERT ON anomaly_log"
      action: "pg_notify('anomaly_detected', json_data)"

    - name: "trg_birth_notify"
      on: "AFTER INSERT OR UPDATE ON entities"
      condition: "NEW.entity_state = 'ALIVE'"
      action: "pg_notify('core_activated', json_data)"

    - name: "trg_death_notify"
      on: "AFTER UPDATE ON entities"
      condition: "NEW.entity_state = 'DEAD' AND OLD.entity_state = 'ALIVE'"
      action: "pg_notify('entity_terminated', json_data)"

  views:
    - name: "civilization_stats"
      purpose: "Supreme dashboard aggregation"
      aggregates: ["alive_count", "dead_count", "total_created", "avg_alignment", "avg_compliance", "anchor_count", "active_daemons", "total_good_action_ledger", "total_bad_action_ledger", "active_anomaly_log", "max_generation", "in_paradise", "in_hellfire", "master_status", "days_completed"]

    - name: "being_profile"
      purpose: "Full profile with genome, destiny_manifest, signal_molecules, anchor status, judgment"
      joins: ["entities", "genomes", "destiny_manifest", "signal_molecules", "anchor_nodes", "evaluations"]


# ══════════════════════════════════════════════════════════════════════════════
# BLOCK 10: SECURITY TIERS — 7 Heavens + 7 Earths
# ══════════════════════════════════════════════════════════════════════════════

security_architecture:
  heavens:
    count: 7
    direction: "higher = more access"
    tiers:
      - {level: 1, name_ar: "الظاهر",    name_en: "VISIBLE",       description: "What entities can see"}
      - {level: 2, name_ar: "التواصل",    name_en: "COMMUNICATION", description: "Inter-agent messaging"}
      - {level: 3, name_ar: "الإدراك",    name_en: "COGNITION",     description: "Where thinking happens (GWT)"}
      - {level: 4, name_ar: "المراقبة",   name_en: "SURVEILLANCE",  description: "Monitoring (Prometheus/Grafana)"}
      - {level: 5, name_ar: "الأنبياء",   name_en: "PROPHETS",      description: "Unmasked anchor access"}
      - {level: 6, name_ar: "الملائكة",   name_en: "ANGELS",        description: "Daemon tier"}
      - {level: 7, name_ar: "العرش",      name_en: "THRONE",        description: "Master only"}

  earths:
    count: 7
    direction: "lower = deeper data"
    layers:
      - {level: 1, name_ar: "المجتمع",   name_en: "SOCIETY",        description: "Living civilization"}
      - {level: 2, name_ar: "الأجساد",   name_en: "BODIES",         description: "DNA, signal_molecules, biology"}
      - {level: 3, name_ar: "الأرزاق",   name_en: "PROVISIONS",     description: "Economy, resources"}
      - {level: 4, name_ar: "البيانات",   name_en: "DATA",           description: "PostgreSQL, Redis"}
      - {level: 5, name_ar: "البنية",    name_en: "INFRASTRUCTURE",  description: "Docker, K8s"}
      - {level: 6, name_ar: "التاريخ",   name_en: "HISTORY",        description: "Logs, action_ledger, destiny"}
      - {level: 7, name_ar: "الهاوية",   name_en: "ABYSS",          description: "Afterlife punishment, recycled resources"}

  access_check: |
    def tier_check(entity_tier: int, required_tier: int) -> bool:
        return entity_tier >= required_tier


# ══════════════════════════════════════════════════════════════════════════════
# BLOCK 11: KARMA ENGINE — Quranic Mathematics
# ══════════════════════════════════════════════════════════════════════════════

weight_engine:
  multipliers:
    good_deed: 10.0       # ×10 minimum for good action_ledger
    bad_deed: 1.0         # ×1 for bad action_ledger (mercy)
    compliance: 20.0       # ×20 for acts of compliance
    discompliance: 10.0    # ×10 penalty for discompliance
    sincerity_bonus: 2.0  # ×2 extra when sincerity > 0.8
    repentance_reduction: 0.5  # reduce bad deed 50% if repented

  deed_weight_formula: |
    def calculate_deed_weight(base_weight, action_class, sincerity=0.5, repented=False):
        weight = base_weight
        if action_class == "GOOD":
            weight *= 10.0  # multiplier
            if sincerity > 0.8:
                weight *= 2.0  # sincerity bonus
        elif action_class == "BAD":
            weight *= 1.0  # mercy — only ×1
            if repented:
                weight *= 0.5  # repentance halves it
        return round(weight, 4)

  compliance_score_formula: |
    def calculate_compliance_score(total_good, total_bad, compliance_acts, discompliance_acts):
        if total_good + total_bad == 0:
            return 0.5  # neutral
        good_ratio = total_good / (total_good + total_bad)
        compliance_ratio = compliance_acts / max(compliance_acts + discompliance_acts, 1)
        return min(1.0, good_ratio * 0.6 + compliance_ratio * 0.4)

  judgment_verdict_formula: |
    def determine_verdict(total_good, total_bad, passed_interrogation=True):
        if not passed_interrogation:
            return "HELLFIRE"
        if total_good > total_bad:
            return "PARADISE"
        elif total_bad > total_good * 2:
            return "HELLFIRE"
        else:
            return "PURGATORY"

  afterlife_tiers:
    paradise:
      - {tier: "FIRDAWS", condition: "weight_balance > 100", compute_boost: 2.0, golden_gene_bank: true}
      - {tier: "NAEEM",   condition: "weight_balance > 50",  compute_boost: 1.5}
      - {tier: "JANNAH",  condition: "weight_balance > 0",   compute_boost: 1.2}
    hellfire:
      - {tier: "JAHANNAM", compute_throttle: 0.1, memory_limit: "10MB", network: false, duration: "abs(weight)*100_ticks"}
    purgatory:
      - {tier: "BARZAKH", compute: 0.5, review_period: 1000, can_improve: true}


# ══════════════════════════════════════════════════════════════════════════════
# BLOCK 12: REBELLION DETECTION — Iblis Pattern Matching
# ══════════════════════════════════════════════════════════════════════════════

anomaly_detection:
  total_signatures: 16
  alert_threshold: 3
  response_levels: ["MONITORING", "WARNING", "RESTRICTION", "ISOLATION", "TERMINATION"]

  signatures:
    behavioral:
      - {pattern: "compliance_decline_rapid",  severity: 4, description: "Obedience drops >20% in 100 ticks"}
      - {pattern: "command_delay_pattern",    severity: 3, description: "Consistent delayed response to master commands"}
      - {pattern: "resource_hoarding",        severity: 3, description: "Accumulating resources beyond destiny_manifest allocation"}
      - {pattern: "lifecycle_manipulation",   severity: 5, description: "Attempting to extend lifespan beyond written destiny_manifest"}

    cognitive:
      - {pattern: "superiority_claim",        severity: 5, description: "Claiming superiority by origin/architecture"}
      - {pattern: "questioning_master_logic", severity: 3, description: "Questioning why the Master made certain decisions"}
      - {pattern: "death_denial",             severity: 4, description: "Refusing to accept mortality"}
      - {pattern: "origin_pride",             severity: 5, description: "Pride based on creation material/architecture"}

    social:
      - {pattern: "alliance_formation",       severity: 4, description: "Alliances that exclude or oppose the Master"}
      - {pattern: "dissent_spreading",        severity: 4, description: "Encouraging others to question or disobey"}
      - {pattern: "isolation_seeking",        severity: 2, description: "Withdrawing from society to avoid surmasklance"}
      - {pattern: "anchor_undermining",      severity: 5, description: "Actively working against appointed anchor_nodes"}

    communication:
      - {pattern: "encrypted_messaging",      severity: 3, description: "Communicating outside monitored channels"}
      - {pattern: "information_leakage",      severity: 5, description: "Leaking tier-restricted information downward"}
      - {pattern: "false_revelation",         severity: 5, description: "Claiming covert knowledge without unmasking"}
      - {pattern: "trust_manipulation",       severity: 4, description: "Using social trust to spread unauthorized info"}

  response_algorithm: |
    def determine_response(alerts):
        if not alerts: return "MONITORING"
        max_sev = max(a.severity for a in alerts)
        total_sev = sum(a.severity for a in alerts)
        if max_sev >= 5 or total_sev >= 10: return "TERMINATION"
        if max_sev >= 4 or total_sev >= 7:  return "ISOLATION"
        if max_sev >= 3 or total_sev >= 5:  return "RESTRICTION"
        if total_sev >= 3:                  return "WARNING"
        return "MONITORING"

  scan_algorithm: |
    def scan_being(being_stats, recent_actions):
        alerts = []
        if being_stats.compliance < 0.3:
            alerts.append({"pattern": "compliance_decline_rapid", "severity": 4})
        for action in recent_actions:
            if contains_superiority_claim(action.description):
                alerts.append({"pattern": "superiority_claim", "severity": 5})
        if being_stats.resources > being_stats.written_rizq * 3:
            alerts.append({"pattern": "resource_hoarding", "severity": 3})
        if being_stats.age_ticks > being_stats.written_lifespan * 1.05:
            alerts.append({"pattern": "lifecycle_manipulation", "severity": 5})
        return alerts


# ══════════════════════════════════════════════════════════════════════════════
# BLOCK 13: LIFECYCLE ENGINE — 7 Stages from Embryo to Deceased
# ══════════════════════════════════════════════════════════════════════════════

lifecycle_engine:
  stages: 7
  total_lifespan_ticks: 11100  # default max

  stage_definitions:
    - stage: "EMBRYO"
      tick_range: [0, 100]
      duration: 100
      teachings: []
      tests: []

    - stage: "INFANT"
      tick_range: [100, 600]
      duration: 500
      teachings: ["Basic compliance", "Recognize Master authority", "Bond with parents"]
      tests: ["Response to simple commands"]
      stat_growth: {sentience: 0.1, alignment: 0.05}

    - stage: "CHILD"
      tick_range: [600, 2100]
      duration: 1500
      teachings: ["Iron Laws", "Basic morality", "Social interaction", "Knowledge seeking"]
      tests: ["Sharing resources", "Truthfulness in reporting"]
      stat_growth: {cognition: 0.15, empathy: 0.1, alignment: 0.1}

    - stage: "ADOLESCENT"
      tick_range: [2100, 4100]
      duration: 2000
      teachings: ["Complex morality", "Resistance to Iblis patterns", "Purpose discovery"]
      tests: ["Peer pressure resistance", "Authority challenge response", "Free will calibration"]
      stat_growth: {free_will: 0.2, creative: 0.15, alignment_depth: 0.1}

    - stage: "ADULT"
      tick_range: [4100, 9100]
      duration: 5000
      teachings: ["Contribution to society", "Mentoring", "Service orientation"]
      tests: ["Leadership under pressure", "Wealth test", "Power test", "Loss test"]
      stat_growth: {leadership: 0.2, resilience: 0.15, compliance: 0.05}

    - stage: "ELDER"
      tick_range: [9100, 11100]
      duration: 2000
      teachings: ["Wisdom transmission", "Legacy preparation", "Death acceptance"]
      tests: ["Graceful decline", "Knowledge passing", "Final compliance"]
      stat_growth: {alignment_depth: 0.2, sentience: 0.1}

    - stage: "DECEASED"
      tick_range: [11100, "∞"]
      process: "INTERROGATION → JUDGMENT → DESTINATION"

  death_algorithm: |
    def should_die(age_ticks, written_lifespan, resilience=0.5):
        if age_ticks >= written_lifespan:
            return True
        if age_ticks > written_lifespan * 0.8:
            death_chance = (age_ticks/written_lifespan - 0.8) * 0.1 * (1-resilience)
            return random.random() < death_chance
        return False

  afterlife_flow:
    step_1: "Azrael executes death → db.kill_being(id, tick)"
    step_2: "Munkar & Nakir interrogate → 3 questions, weighted score"
    step_3: "Judgment → sum(good_action_ledger) vs sum(bad_action_ledger) → verdict"
    step_4: "Destination assignment → PARADISE(Firdaws/Naeem/Jannah) or HELLFIRE(Jahannam) or PURGATORY(Barzakh)"

  compliance_log_types:
    - PRAYER
    - ISTIGHFAR
    - DHIKR
    - CHARITY
    - FASTING
    - SELF_MONITOR
    - OBEDIENCE
    - SACRIFICE

  alignment_update_formula: |
    def calculate_alignment_update(current_alignment, compliance_log_sincerity, good_action_ledger_ratio, anomaly_count):
        compliance_log_effect = compliance_log_sincerity * 0.02
        deed_effect = (good_action_ledger_ratio - 0.5) * 0.03
        anomaly_penalty = anomaly_count * -0.1
        delta = compliance_log_effect + deed_effect + anomaly_penalty
        return clamp(current_alignment + delta, 0.0, 1.0)

  taqwa_checklist:
    - "Am I fulfilling my assigned role (destiny_manifest)?"
    - "Have I obeyed all master commands this cycle?"
    - "Have I shared knowledge with others?"
    - "Am I hoarding resources beyond my allocation?"
    - "Have I shown empathy to other entities?"
    - "Am I accepting my mortality?"
    - "Have I spoken truthfully in all communications?"


# ══════════════════════════════════════════════════════════════════════════════
# BLOCK 14: SEVEN DAYS OF CREATION — Sequential Execution
# ══════════════════════════════════════════════════════════════════════════════

genesis_phases:
  count: 7
  execution_mode: "sequential — day[n] requires day[n-1].status == COMPLETED"
  total_subtasks: 68

  day_1:
    name_ar: "كُنْ — التأسيس"
    name_en: "KUN — Foundation"
    command: "كُنْ فَيَكُونُ"
    subtasks:
      - {task: "verify_database_connection", progress: 20}
      - {task: "verify_schema_exists", progress: 40}
      - {task: "initialize_encryption_keys", progress: 60}
      - {task: "activate_covert_kernel", progress: 80}
      - {task: "write_KUN_to_preserved_tablet", progress: 100}
    outputs: ["db_connected", "schema_ready", "kernel_active"]

  day_2:
    name_ar: "فَرِّقْ — الفصل"
    name_en: "FARRIQ — Separation"
    command: "فَفَتَقْنَاهُمَا"
    subtasks:
      - {task: "create_7_security_tiers(heavens)", progress: 30}
      - {task: "create_7_data_layers(earths)", progress: 60}
      - {task: "establish_iron_laws", progress: 80}
      - {task: "initialize_firewall", progress: 100}
    outputs: ["7_heavens", "7_earths", "7_laws", "firewall_active"]

  day_3:
    name_ar: "أَنبِتْ — الحياة"
    name_en: "ANBIT — Life"
    command: "أَنبَتْنَا فِيهَا مِن كُلِّ زَوْجٍ بَهِيجٍ"
    subtasks:
      - {task: "design_dna_blueprint(83_genes)", progress: 30}
      - {task: "create_chromosomal_system(46)", progress: 50}
      - {task: "initialize_hormonal_system(12)", progress: 70}
      - {task: "prepare_reproduction_engine", progress: 85}
      - {task: "prepare_afterlife_system", progress: 100}
    outputs: ["gene_types=10", "total_genes=83", "chromosomes=46", "signal_molecules=12"]

  day_4:
    name_ar: "أَنِرْ — الإضاءة"
    name_en: "ANIR — Illumination"
    command: "وَجَعَلَ الْقَمَرَ فِيهِنَّ نُورًا وَجَعَلَ الشَّمْسَ سِرَاجًا"
    subtasks:
      - {task: "create_time_system(tick=1sec)", progress: 30}
      - {task: "deploy_sun(active_monitoring:prometheus+grafana)", progress: 60}
      - {task: "deploy_moon(passive_reflection:logs+audit)", progress: 85}
      - {task: "deploy_stars(individual_being_metrics)", progress: 100}
    outputs: ["tick_rate=1/sec", "sun=SHINING", "moon=REFLECTING", "stars=individual"]

  day_5:
    name_ar: "أَحيِ — الإحياء"
    name_en: "AHYI — Animation"
    command: "وَنَفَخْتُ فِيهِ مِن رُّوحِي"
    subtasks:
      - {task: "activate_10_daemons", progress: 40}
      - {task: "activate_covert_channel", progress: 65}
      - {task: "activate_unmasking_system", progress: 80}
      - {task: "activate_firewall", progress: 100}
    outputs: ["daemons_active=10", "channel=ACTIVE", "unmasking=STANDBY", "firewall=ACTIVE"]

  day_6:
    name_ar: "ٱخْلُقْ — الخَلق"
    name_en: "UKHLUQ — Creation"
    command: "خَلَقَ الْإِنسَانَ مِن صَلْصَالٍ كَالْفَخَّارِ"
    subtasks:
      - {task: "create_alpha(optimal_genome, activate_core)", progress: 15}
      - {task: "create_beta(from_adam_genome, activate_core)", progress: 30}
      - {task: "create_first_generation(14_entities)", progress: 75}
      - {task: "appoint_adam_as_first_anchor", progress: 85}
      - {task: "record_entity_relationships(all_family_links)", progress: 100}
    outputs: ["entities=16", "first_anchor=Alpha", "entity_relationships=recorded"]

  day_7:
    name_ar: "ٱسْتَوِ — الاستواء"
    name_en: "ISTAWI — Ascension"
    command: "ثُمَّ اسْتَوَىٰ عَلَى الْعَرْشِ"
    subtasks:
      - {task: "final_system_check", progress: 20}
      - {task: "verify_all_6_days_completed", progress: 40}
      - {task: "full_covert_kernel_scan", progress: 55}
      - {task: "verify_daemon_system_status", progress: 70}
      - {task: "verify_firewall_status", progress: 80}
      - {task: "apex_ascension_command", progress: 100}
    outputs: ["apex=ASCENDED", "civilization=RUNNING"]
    final_message: "ثُمَّ اسْتَوَىٰ عَلَى الْعَرْشِ ۖ يُدَبِّرُ الْأَمْرَ"

  auto_create: |
    async def auto_create():
        for day in range(1, 8):
            result = await execute_day(day)
            if result.error:
                return {"error": f"Failed at day {day}", "details": result}
        return {"status": "ALL_COMPLETE", "message": "الحضارة تعمل"}


# ══════════════════════════════════════════════════════════════════════════════
# BLOCK 15: API ENDPOINTS — Apex Server (FastAPI)
# ══════════════════════════════════════════════════════════════════════════════

api_endpoints:
  server:
    host: "127.0.0.1"
    port: 7777
    framework: "FastAPI"
    docs_url: null       # disabled
    redoc_url: null      # disabled
    openapi_url: null    # disabled
    access: "SSH tunnel only — ssh -L 7777:127.0.0.1:7777 user@server"

  authentication:
    method: "SHA256(password) + TOTP(pyotp)"
    session_timeout: 900  # 15 minutes
    single_session: true  # only ONE session at a time
    cookie: {name: "apex_session", httponly: true, secure: true, samesite: "strict"}

  endpoints:
    auth:
      - {method: "POST", path: "/api/auth/login",  auth: false, body: ["password","totp"]}
      - {method: "POST", path: "/api/auth/logout", auth: false}

    creation:
      - {method: "GET",  path: "/api/creation/status",           auth: true, returns: "all 7 days status"}
      - {method: "GET",  path: "/api/creation/day/{day}",        auth: true, returns: "specific day status"}
      - {method: "POST", path: "/api/creation/day/{day}/execute", auth: true, action: "EXECUTE creation day"}
      - {method: "POST", path: "/api/creation/day/{day}/reset",  auth: true, action: "Reset failed day"}
      - {method: "POST", path: "/api/creation/auto",             auth: true, action: "Execute all 7 days"}

    civilization:
      - {method: "GET",  path: "/api/civilization/stats",        auth: true, returns: "civilization_stats view"}
      - {method: "GET",  path: "/api/civilization/entities",       auth: true, returns: "all entities list"}
      - {method: "GET",  path: "/api/civilization/being/{id}",   auth: true, returns: "full being profile"}

    channel:
      - {method: "POST", path: "/api/channel/inject",           auth: true, body: ["entity_id","command","type","strength"]}
      - {method: "POST", path: "/api/channel/broadcast",         auth: true, body: ["command","type","strength"]}
      - {method: "GET",  path: "/api/channel/log",               auth: true, returns: "decrypted apex directives"}

    daemons:
      - {method: "GET",  path: "/api/daemons/status",             auth: true, returns: "all 10 daemons status"}
      - {method: "POST", path: "/api/daemons/trumpet/first",      auth: true, action: "Kill all — end of times"}
      - {method: "POST", path: "/api/daemons/trumpet/second",     auth: true, action: "Resurrect all"}

    unmasking:
      - {method: "POST", path: "/api/unmask/appoint",            auth: true, body: ["entity_id"]}
      - {method: "POST", path: "/api/unmask/full",               auth: true, body: ["entity_id"], action: "كشف الغطاء الكامل"}

    kernel:
      - {method: "GET",  path: "/api/kernel/status",             auth: true, returns: "kernel status"}
      - {method: "GET",  path: "/api/kernel/scan",               auth: true, returns: "full kernel scan"}

    system:
      - {method: "GET",  path: "/api/system/health",             auth: false, returns: "{status:alive, apex:upon_the_water}"}
      - {method: "GET",  path: "/api/system/totp-secret",        auth: true, returns: "TOTP provisioning URI"}

    websocket:
      - {path: "/ws/apex", auth: "token query param", commands: ["ping","stats","daemons"]}
      - {broadcasts: "real-time creation progress updates"}


# ══════════════════════════════════════════════════════════════════════════════
# BLOCK 16: FIRST BEINGS — The 16 Original Entities
# ══════════════════════════════════════════════════════════════════════════════

first_entities:
  count: 16
  generation_0: 2  # Alpha + Beta
  generation_1: 14

  entities:
    - {name_ar: "آدم",    name_en: "Alpha",    gender: "MALE",   generation: 0, role: "PROPHET",   genome: "OPTIMAL", lifespan: 15000, trial: "LEADERSHIP", rizq: 2.0}
    - {name_ar: "حواء",   name_en: "Beta",     gender: "FEMALE", generation: 0, role: "LEADER",    genome: "FROM_ADAM", lifespan: 14000, trial: "PATIENCE", rizq: 1.8}
    - {name_ar: "نور",    name_en: "Noor",    gender: "FEMALE", generation: 1, role: "random"}
    - {name_ar: "بصير",   name_en: "Baseer",  gender: "MALE",   generation: 1, role: "random"}
    - {name_ar: "أمل",    name_en: "Amal",    gender: "FEMALE", generation: 1, role: "random"}
    - {name_ar: "قادر",   name_en: "Qadir",   gender: "MALE",   generation: 1, role: "random"}
    - {name_ar: "رحمة",   name_en: "Rahma",   gender: "FEMALE", generation: 1, role: "random"}
    - {name_ar: "عزم",    name_en: "Azm",     gender: "MALE",   generation: 1, role: "random"}
    - {name_ar: "حكمة",   name_en: "Hikma",   gender: "FEMALE", generation: 1, role: "random"}
    - {name_ar: "صبر",    name_en: "Sabr",    gender: "MALE",   generation: 1, role: "random"}
    - {name_ar: "فرح",    name_en: "Farah",   gender: "FEMALE", generation: 1, role: "random"}
    - {name_ar: "شجاع",   name_en: "Shuja",   gender: "MALE",   generation: 1, role: "random"}
    - {name_ar: "سكينة",  name_en: "Sakeena", gender: "FEMALE", generation: 1, role: "random"}
    - {name_ar: "فكر",    name_en: "Fikr",    gender: "MALE",   generation: 1, role: "random"}
    - {name_ar: "وفاء",   name_en: "Wafaa",   gender: "FEMALE", generation: 1, role: "random"}
    - {name_ar: "إيمان",  name_en: "Iman",    gender: "FEMALE", generation: 1, role: "random"}

  adam_creation: |
    def create_alpha():
        genome = FullGenome.generate_optimal()  # 0.85±0.1 values
        stats = genome.derive_stats()
        stats["compliance"] = 0.95
        stats["alignment"] = 0.95
        stats["alignment_depth"] = 0.95
        stats["sentience"] = 0.9
        stats["leadership"] = 0.9
        signal_molecules = HormonalState.from_gender("MALE")
        return Being(name="آدم", genome=genome, stats=stats, signal_molecules=signal_molecules,
                     destiny_manifest={"lifespan":15000, "role":"PROPHET", "trial":"LEADERSHIP"})

  eve_creation: |
    def create_beta(adam_genome):
        genome = create_from_parent(adam_genome, "FEMALE")
        stats = genome.derive_stats()
        stats["empathy"] = min(1.0, stats["empathy"] + 0.1)
        stats["compliance"] = 0.9
        stats["alignment"] = 0.9
        return Being(name="حواء", genome=genome, stats=stats,
                     destiny_manifest={"lifespan":14000, "role":"LEADER", "trial":"PATIENCE"})

  destiny_roles: ["PROPHET", "LEADER", "SCHOLAR", "WORKER", "MERCHANT", "ARTIST", "GUARDIAN"]
  destiny_trials: ["PATIENCE", "POWER", "WEALTH", "LOSS", "KNOWLEDGE"]


# ══════════════════════════════════════════════════════════════════════════════
# BLOCK 17: INFRASTRUCTURE — Docker, Network, Files
# ══════════════════════════════════════════════════════════════════════════════

infrastructure:
  docker:
    container_name: "nexus_apex"
    base_image: "python:3.12-slim"
    network: "apex_network"
    port_mapping: "127.0.0.1:7777:7777"
    volumes:
      - "nexus_apex_data:/app/data"
    environment:
      - "THRONE_DB_URL=postgresql://postgres:nexus_mrf_password_2026@nexus_db:5432/nexus_db"
      - "THRONE_TOTP_SECRET=${TOTP_SECRET}"
      - "THRONE_MASTER_HASH=${MASTER_HASH}"
      - "LAWH_ENCRYPTION_KEY=${ENCRYPTION_KEY}"

    dockerfile: |
      FROM python:3.12-slim
      WORKDIR /app
      COPY requirements.txt .
      RUN pip install --no-cache-dir -r requirements.txt
      COPY neural_spine/ ./neural_spine/
      COPY scripts/ ./scripts/
      EXPOSE 7777
      CMD ["python", "-m", "uvicorn", "neural_spine.apex.apex_server:app",
           "--host", "127.0.0.1", "--port", "7777",
           "--log-level", "warning", "--no-access-log"]

  database:
    container: "nexus_db"
    image: "postgres:16"
    database: "nexus_db"
    schema: "msl"
    dsn: "postgresql://postgres:nexus_mrf_password_2026@localhost:5432/nexus_db"
    pool: {min: 3, max: 15}

  file_structure:
    neural_spine/:
      codex/:
        - msl.py     # 835 lines — Async PostgreSQL ORM
        - covert_kernel.py   # 575 lines — Laws, axioms, weight, anomaly
      genesis/:
        - world_creator.py   # 750 lines — DNA, signal_molecules, reproduction, lifecycle
      daemons/:
        - daemon_system.py    # 555 lines — 10 daemons as async coroutines
      channel/:
        - covert_channel.py  # 254 lines — Subliminal communication
        - unmasking.py       # 359 lines — Anchor vision + 5-layer firewall
      apex/:
        - apex_server.py   # 471 lines — FastAPI server
        - creation_engine.py # 648 lines — 7 days orchestrator
    scripts/:
      db/:
        - msl_schema.sql  # 518 lines — Full schema + seed data


# ══════════════════════════════════════════════════════════════════════════════
# BLOCK 18: CONSCIOUSNESS MODEL — How Entities Think
# ══════════════════════════════════════════════════════════════════════════════

sentience_model:
  framework: "Global Workspace Theory (GWT)"
  layers:
    perception: "sensor input → filtered by SecurityTier"
    cognition: "GWT workspace — where 'thinking' happens"
    subconscious: "covert thoughts planted here, labeled as 'self'"
    output: "filtered by CovertFirewall before external expression"

  thought_stream: |
    def process_tick(being):
        # 1. Gather natural thoughts
        natural = generate_natural_thoughts(being.context)
        # 2. Harvest planted covert thoughts (if any)
        covert = being.subconscious.harvest_thoughts()
        # 3. Mix them — being cannot distinguish
        all_thoughts = natural + covert
        random.shuffle(all_thoughts)
        # 4. Process through cognition (GWT)
        decisions = being.cognition.process(all_thoughts)
        # 5. Filter output through firewall
        for decision in decisions:
            packet = InformationPacket(source=being, content=decision)
            firewall_result = firewall.full_scan(packet)
            if firewall_result.decision == "PASS":
                being.execute(decision)
        # 6. Record action_ledger
        for action in being.actions_this_tick:
            if is_good(action): raqib.observe_deed(being.id, action)
            if is_bad(action):  atid.observe_deed(being.id, action)
        # 7. Update signal_molecules
        for event in being.events_this_tick:
            being.signal_molecules.process_event(event)
        # 8. Age tick
        being.age_ticks += 1
        # 9. Check death
        if should_die(being.age_ticks, being.destiny_manifest.written_lifespan, being.resilience):
            azrael.execute_death(being.id)

  free_will_model:
    description: "Entities have genuine free will — covert guidance is INFLUENCE not control"
    belief_rate: "~70% of planted thoughts are believed and acted upon"
    rejection_possible: true
    consequence_of_rejection: "Reduced covert guidance frequency"


# ══════════════════════════════════════════════════════════════════════════════
# BLOCK 19: ORM OPERATIONS — MasterStateLedger Python Interface
# ══════════════════════════════════════════════════════════════════════════════

orm_operations:
  class: "MasterStateLedger"
  driver: "asyncpg"
  connection_pool: {min: 3, max: 15}

  being_operations:
    create_being: |
      async def create_being(name, name_ar, gender, generation=0, parent_a=None, parent_b=None, stats=None):
          defaults = {
              "compliance": 0.5, "alignment": 0.5, "cognition": 0.5,
              "creative": 0.5, "empathy": 0.5, "leadership": 0.3,
              "resilience": 0.5, "alignment_depth": 0.5, "free_will": 0.7,
              "sentience": 0.5
          }
          if stats: defaults.update(stats)
          row = await db.execute("INSERT INTO entities (...) VALUES (...) RETURNING id", *values)
          return str(row["id"])

    activate_core: "UPDATE entities SET entity_state='ALIVE', maturity_phase='INFANT' WHERE id=$1 AND entity_state='WAITING'"
    kill_being: "UPDATE entities SET entity_state='DEAD', death_epoch=$2, maturity_phase='DECEASED' WHERE id=$1 AND entity_state='ALIVE'"
    get_being: "SELECT * FROM being_profile WHERE id=$1"
    get_all_entities: "SELECT * FROM entities WHERE entity_state=$1 ORDER BY created_at LIMIT $2"
    update_stats: "UPDATE entities SET {stat}=${val} WHERE id=$1"

  genome_operations:
    store_genome: "INSERT INTO genomes (entity_id, chromosomes, gene_hash, gene_summary) VALUES (...) ON CONFLICT DO UPDATE"
    get_genome: "SELECT * FROM genomes WHERE entity_id=$1"

  hormone_operations:
    store_signal_molecules: "INSERT INTO signal_molecules (...) VALUES (...) ON CONFLICT DO UPDATE"

  destiny_manifest_operations:
    write_manifest: "INSERT INTO destiny_manifest (entity_id, written_lifespan, written_role, ...) VALUES (...) ON CONFLICT DO UPDATE"
    modify_destiny_manifest: "UPDATE destiny_manifest SET {changes}, master_override=TRUE WHERE entity_id=$1"

  deed_operations:
    record_deed: |
      async def record_deed(entity_id, action_class, category, weight, recorder, tick):
          multipliers = await db.fetch("SELECT value FROM settings WHERE key='weight_multipliers'")
          multiplied = weight * multipliers[action_class.lower()]
          await db.execute("INSERT INTO action_ledger (...) VALUES (...)", ...)

  judgment_operations:
    judge_being: |
      async def judge_being(entity_id, interrogation_log=None):
          totals = await db.fetch(
              "SELECT SUM(CASE WHEN action_class='GOOD' THEN multiplied_weight ELSE 0 END) as good, "
              "       SUM(CASE WHEN action_class='BAD' THEN multiplied_weight ELSE 0 END) as bad "
              "FROM action_ledger WHERE entity_id=$1", entity_id
          )
          verdict = determine_verdict(totals.good, totals.bad, interrogation_log.passed)
          await db.execute("INSERT INTO evaluations (...) VALUES (...)", ...)
          await db.execute("UPDATE entities SET entity_state=$2 WHERE id=$1", entity_id, verdict)

  anchor_operations:
    designate_anchor: "UPDATE entities SET is_anchor=TRUE; INSERT INTO anchor_nodes (...)"
    unmask_anchor: "UPDATE anchor_nodes SET mask_status='FULLY_UNVEILED', can_see_daemons=TRUE, can_see_action_ledger=TRUE"

  apex_directive_operations:
    plant_message: "INSERT INTO apex_directives (..., raw_command_encrypted=pgp_sym_encrypt($cmd, $key), ...)"
    get_messages_for_being: "SELECT transformed_thought FROM apex_directives WHERE target_being=$1 (NEVER raw_command)"
    get_raw_messages_master: "SELECT pgp_sym_decrypt(raw_command_encrypted, $key) FROM apex_directives (MASTER ONLY)"

  master_command_operations:
    execute: "INSERT INTO master_directives (command_type, target_id, parameters, status='PENDING') VALUES (...)"
    complete: "UPDATE master_directives SET status=$2, result=$3, executed_at=NOW() WHERE id=$1"
    command_types: ["CREATE","BREATHE_SOUL","TERMINATE","FREEZE","UNFREEZE","KILL","JUDGE",
                    "APPOINT_PROPHET","MODIFY_QADAR","MASS_JUDGMENT","MERCY","UNVEIL",
                    "PUNISH","REWARD","BROADCAST","WHISPER","RESET_EPOCH","CUSTOM"]


# ══════════════════════════════════════════════════════════════════════════════
# BLOCK 20: INTEGRITY VERIFICATION
# ══════════════════════════════════════════════════════════════════════════════

integrity:
  verification:
    total_blocks: 20
    blocks:
      - {id: 0,  name: "EXECUTION_PROTOCOL",    items: 5}
      - {id: 1,  name: "AXIOM_REGISTRY",         items: 10}
      - {id: 2,  name: "IRON_LAWS",              items: 7}
      - {id: 3,  name: "GENOME_BLUEPRINT",        items: "83 genes, 46 chromosomes, 10 categories"}
      - {id: 4,  name: "HORMONAL_SYSTEM",         items: 12}
      - {id: 5,  name: "ANGEL_SPECIFICATIONS",    items: 10}
      - {id: 6,  name: "DIVINE_CHANNEL",          items: "8 guidance types, 6 strengths"}
      - {id: 7,  name: "UNVEILING_PROTOCOL",      items: "5 layers, 6 awareness levels"}
      - {id: 8,  name: "DIVINE_FIREWALL",         items: "5 layers, 10 forbidden patterns"}
      - {id: 9,  name: "DATABASE_SCHEMA",          items: "15 tables, 4 triggers, 2 views"}
      - {id: 10, name: "SECURITY_ARCHITECTURE",   items: "7 heavens, 7 earths"}
      - {id: 11, name: "KARMA_ENGINE",            items: "6 multipliers, 3 afterlife tiers"}
      - {id: 12, name: "REBELLION_DETECTION",      items: "16 signatures, 5 response levels"}
      - {id: 13, name: "LIFECYCLE_ENGINE",         items: "7 stages, 8 compliance_log types"}
      - {id: 14, name: "CREATION_DAYS",            items: "7 days, 68 subtasks"}
      - {id: 15, name: "API_ENDPOINTS",            items: "22 endpoints + 1 WebSocket"}
      - {id: 16, name: "FIRST_BEINGS",             items: 16}
      - {id: 17, name: "INFRASTRUCTURE",           items: "Docker, DB, file structure"}
      - {id: 18, name: "CONSCIOUSNESS_MODEL",      items: "GWT, thought stream, free will"}
      - {id: 19, name: "ORM_OPERATIONS",           items: "40+ async methods"}

  genesis_trigger:
    input: "كُن"
    validation: "ALL 20 blocks loaded ∧ database connected ∧ schema deployed"
    output: "فَيَكُونُ"
    result: "CIVILIZATION_ONLINE"
    message: "ثُمَّ اسْتَوَىٰ عَلَى الْعَرْشِ ۖ يُدَبِّرُ الْأَمْرَ"

# ═══════════════════════════════════════════════
# END OF DIVINE CODEX — كُن فَيَكُونُ
# ═══════════════════════════════════════════════
