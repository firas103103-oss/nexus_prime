services:
  nexus_db:
    image: supabase/postgres:15.1.0.147
    container_name: nexus_db
    env_file: .env
    volumes:
      - ./data/db_data:/var/lib/postgresql/data
    networks:
      - nexus_network
    restart: always
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 5
      start_period: 10s

  nexus_ollama:
    image: ollama/ollama:latest
    container_name: nexus_ollama
    volumes:
      - ./data/ollama:/root/.ollama
    ports:
      - "11434:11434"
    networks:
      - nexus_network
    restart: always

  # ═══ PHASE 1: LiteLLM Sovereignty Proxy ═══════════════════════
  nexus_litellm:
    image: ghcr.io/berriai/litellm:main-latest
    container_name: nexus_litellm
    ports:
      - "4000:4000"
    command: --config /app/config.yaml --port 4000
    volumes:
      - ./litellm_config.yaml:/app/config.yaml:ro
    environment:
      - LITELLM_MASTER_KEY=sk-nexus-sovereign-mrf103
    depends_on:
      - nexus_ollama
    networks:
      - nexus_network
    restart: always
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4000/health/liveliness"]
      interval: 30s
      timeout: 15s
      retries: 5
      start_period: 90s

  # ═══ PHASE 2: Redis Event Bus ═════════════════════════════════
  nexus_redis:
    image: redis:7-alpine
    container_name: nexus_redis
    ports:
      - "6379:6379"
    command: redis-server --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru
    volumes:
      - ./data/redis_data:/data
    networks:
      - nexus_network
    restart: always
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 5s
      retries: 3

  nexus_voice:
    build: ./edge-tts-repo
    container_name: nexus_voice
    ports:
      - "5050:8000"
    networks:
      - nexus_network
    restart: always

  nexus_boardroom:
    build: /root/products/cognitive-boardroom
    container_name: nexus_boardroom
    ports:
      - "8501:8501"
    env_file: .env
    environment:
      - OPENAI_BASE_URL=http://nexus_litellm:4000/v1
      - OPENAI_API_KEY=sk-nexus-sovereign-mrf103
      - MODEL_NAME=llama3.2:3b
      - DATABASE_URL=postgresql://postgres:${POSTGRES_PASSWORD}@nexus_db:5432/${POSTGRES_DB}
      - VOICE_ENGINE_URL=http://nexus_voice:8000
    depends_on:
      - nexus_db
      - nexus_ollama
      - nexus_voice
      - nexus_litellm
    networks:
      - nexus_network
    restart: always
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8501/_stcore/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # X-BIO Sentinel — Edge Intelligence
  nexus_xbio:
    build: /root/products/xbio-sentinel
    container_name: nexus_xbio
    ports:
      - "8080:8080"
    networks:
      - nexus_network
    restart: always
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s

  nexus_dashboard:
    build:
      context: .
      dockerfile: Dockerfile.dashboard
    container_name: nexus_dashboard
    ports:
      - "5001:5001"
    env_file: .env
    environment:
      - OPENAI_BASE_URL=http://nexus_litellm:4000/v1
      - OPENAI_API_KEY=sk-nexus-sovereign-mrf103
      - ELEVENLABS_API_URL=http://nexus_voice:8000/v1
    networks:
      - nexus_network
    depends_on:
      - nexus_db
      - nexus_ollama
      - nexus_litellm
    restart: always

  # Open WebUI - AI Chat Interface
  nexus_ai:
    image: ghcr.io/open-webui/open-webui:main
    container_name: nexus_ai
    environment:
      - OLLAMA_BASE_URL=http://nexus_ollama:11434
      - OPENAI_API_BASE_URL=http://nexus_litellm:4000/v1
      - OPENAI_API_KEY=sk-nexus-sovereign-mrf103
      - DEFAULT_MODELS=llama3.2:3b
      - WEBUI_SECRET_KEY=nexus_wiring_103
      - TZ=Asia/Riyadh
    ports:
      - "3000:8080"
    volumes:
      - ./data/open-webui:/app/backend/data
    networks:
      - nexus_network
    depends_on:
      - nexus_ollama
      - nexus_litellm
    restart: always

  # n8n Workflow Automation
  nexus_flow:
    image: n8nio/n8n:latest
    container_name: nexus_flow
    environment:
      - N8N_BASIC_AUTH_ACTIVE=true
      - N8N_BASIC_AUTH_USER=admin
      - N8N_BASIC_AUTH_PASSWORD=nexus_mrf_flow_2026
      - N8N_HOST=n8n.mrf103.com
      - N8N_PORT=5678
      - N8N_PROTOCOL=https
      - NODE_ENV=production
      - WEBHOOK_URL=https://n8n.mrf103.com/
      - GENERIC_TIMEZONE=Asia/Riyadh
      - TZ=Asia/Riyadh
    ports:
      - "5678:5678"
    volumes:
      - ./data/n8n_data:/home/node/.n8n
    networks:
      - nexus_network
    restart: always

  # Nginx Proxy Manager (Disabled - using system nginx)
  # nexus_gatekeeper:
  #   image: jc21/nginx-proxy-manager:latest
  #   container_name: nexus_gatekeeper
  #   ports:
  #     - "80:80"
  #     - "81:81"
  #     - "443:443"
  #   volumes:
  #     - ./data/npm_data:/data
  #     - ./data/npm_letsencrypt:/etc/letsencrypt
  #   networks:
  #     - nexus_network
  #   restart: always

  # ─── NEXUS CORTEX — المركز العصبي المركزي ───────────────────
  nexus_cortex:
    build: ./nexus_cortex
    container_name: nexus_cortex
    ports:
      - "8090:8090"
    extra_hosts:
      - "host.docker.internal:host-gateway"
    environment:
      - DATABASE_URL=postgresql://postgres:${POSTGRES_PASSWORD:-nexus_mrf_password_2026}@nexus_db:5432/${POSTGRES_DB:-nexus_db}
      - REDIS_URL=redis://nexus_redis:6379/0
      - SPINE_URL=http://host.docker.internal:8300
    networks:
      - nexus_network
    depends_on:
      - nexus_db
      - nexus_redis
    restart: always
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8090/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s

  shadow7_api:
    build: /root/products/shadow-seven-publisher/backend
    container_name: shadow7_api
    ports:
      - "8002:8002"
    environment:
      - DATABASE_URL=postgresql://postgres:${POSTGRES_PASSWORD:-nexus_mrf_password_2026}@nexus_db:5432/${POSTGRES_DB:-nexus_db}
      - OLLAMA_URL=http://nexus_ollama:11434
      - N8N_WEBHOOK_URL=http://nexus_flow:5678/webhook/shadow7-generate
    volumes:
      - /var/www/shadow7:/var/www/shadow7
    networks:
      - nexus_network
    depends_on:
      - nexus_db
      - nexus_ollama
    restart: always
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8002/api/shadow7/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s

  # PostgREST — Supabase-compatible REST API (Shadow 7 Publisher)
  nexus_postgrest:
    image: postgrest/postgrest:v12.2.0
    container_name: nexus_postgrest
    ports:
      - "3001:3000"
    environment:
      - PGRST_DB_URI=postgresql://postgres:${POSTGRES_PASSWORD:-nexus_mrf_password_2026}@nexus_db:5432/${POSTGRES_DB:-nexus_db}
      - PGRST_DB_SCHEMAS=public
      - PGRST_DB_ANON_ROLE=web_anon
      - PGRST_JWT_SECRET=${JWT_SECRET:-61000362792c462e2e662a985ba4151231f7c1236c7b02ccdee9cee3acc85260}
    networks:
      - nexus_network
    depends_on:
      nexus_db:
        condition: service_healthy
    restart: always

  # ═══ PHASE 3: RS256 Auth Service ══════════════════════════════
  nexus_auth:
    build: ../integration/shared-auth
    container_name: nexus_auth
    ports:
      - "8003:8002"
    volumes:
      - ./data/auth_keys:/app/keys
    environment:
      - DATABASE_URL=postgresql://postgres:${POSTGRES_PASSWORD:-nexus_mrf_password_2026}@nexus_db:5432/${POSTGRES_DB:-nexus_db}
      - JWT_TOKEN_EXPIRY=86400
    networks:
      - nexus_network
    depends_on:
      - nexus_db
    restart: always
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8002/api/v1/auth/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ═══ NEXUS MEMORY KEEPER - حارس الذاكرة المركزية ══════════
  nexus_memory_keeper:
    build: ./memory_keeper
    container_name: nexus_memory_keeper
    ports:
      - "9000:9000"  # API
      - "9001:9001"  # Web UI
    environment:
      - DATABASE_URL=postgresql://postgres:${POSTGRES_PASSWORD:-nexus_mrf_password_2026}@nexus_db:5432/${POSTGRES_DB:-nexus_db}
      - CORTEX_URL=http://nexus_cortex:8090
      - LITELLM_URL=http://nexus_litellm:4000
      - LITELLM_MASTER_KEY=sk-nexus-sovereign-mrf103
    depends_on:
      - nexus_db
      - nexus_cortex
      - nexus_litellm
      - nexus_redis
    networks:
      - nexus_network
    restart: always
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # ═══ META-ORCHESTRATOR — الدماغ المركزي gRPC ══════════════════
  nexus_orchestrator:
    image: nexus_orchestrator:v1.1.0
    container_name: nexus_orchestrator
    ports:
      - "50051:50051"
    environment:
      - CORTEX_URL=http://nexus_cortex:8090
      - REDIS_URL=redis://nexus_redis:6379/0
      - GRPC_PORT=50051
      - MAX_WORKERS=10
      - STALENESS_THRESHOLD=60
      - PYTHONUNBUFFERED=1
    networks:
      - nexus_network
    depends_on:
      nexus_cortex:
        condition: service_healthy
      nexus_redis:
        condition: service_started
      nexus_db:
        condition: service_healthy
    restart: always
    healthcheck:
      test: ["CMD", "/bin/grpc_health_probe", "-addr=localhost:50051"]
      interval: 15s

  # ═══ NEXUS NERVE — الجهاز العصبي المركزي ══════════════════════
  nexus_nerve:
    build: ./nexus_nerve
    container_name: nexus_nerve
    ports:
      - "8200:8200"
    extra_hosts:
      - "host.docker.internal:host-gateway"
    environment:
      - OLLAMA_URL=http://nexus_ollama:11434
      - LITELLM_URL=http://nexus_litellm:4000
      - LITELLM_KEY=sk-nexus-sovereign-mrf103
      - DATABASE_URL=postgresql://postgres:${POSTGRES_PASSWORD:-nexus_mrf_password_2026}@nexus_db:5432/${POSTGRES_DB:-nexus_db}
      - MEMORY_KEEPER_URL=http://nexus_memory_keeper:9000
      - SMTP_HOST=${SMTP_HOST:-smtp.gmail.com}
      - SMTP_PORT=${SMTP_PORT:-587}
      - SMTP_USER=${SMTP_USER:-}
      - SMTP_PASS=${SMTP_PASS:-}
      - SMTP_FROM_EMAIL=${SMTP_FROM_EMAIL:-}
      - SMTP_FROM_NAME=${SMTP_FROM_NAME:-NEXUS PRIME}
      - SPINE_URL=http://host.docker.internal:8300
    volumes:
      - ./AI_HR_REGISTRY:/root/NEXUS_PRIME_UNIFIED/AI_HR_REGISTRY:ro
      - ./nexus_nerve/genome_state.json:/root/NEXUS_PRIME_UNIFIED/nexus_nerve/genome_state.json
    networks:
      - nexus_network
    depends_on:
      - nexus_db
      - nexus_ollama
      - nexus_litellm
    restart: always
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8200/health"]
      interval: 30s
      timeout: 15s
      retries: 5
      start_period: 45s

  # ═══ SOVEREIGN GATEWAY — AS-SULTAN Port 9999 (Genesis Protocol) ═════
  sovereign_gateway:
    build:
      context: .
      dockerfile: Dockerfile.gateway
    container_name: sovereign_gateway
    ports:
      - "9999:9999"
    environment:
      - NERVE_URL=http://nexus_nerve:8200
      - APEX_URL=http://nexus_apex:7777
      - OLLAMA_URL=http://nexus_ollama:11434
      - EDGE_TTS_URL=http://nexus_voice:8000
      - GATEWAY_PORT=9999
    networks:
      - nexus_network
    depends_on:
      - nexus_nerve
    restart: always
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9999/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s

  # ═══ Ecosystem API — Port 8005 (mrf103.com /api/) ═══════════
  ecosystem_api:
    build: ./integration/ecosystem-api
    container_name: ecosystem_api
    ports:
      - "8005:8005"
    environment:
      - PRODUCTS_DIR=/products
      - ECOSYSTEM_DATA_DIR=/data
    volumes:
      - /root/products:/products:ro
      - ecosystem_api_data:/data
    networks:
      - nexus_network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8005/health"]
      interval: 30s
      timeout: 5s
      retries: 3

  # ═══ PHASE 8: Nexus Oracle — RAG Documentation AI ═══════════
  nexus_oracle:
    build: ./nexus_oracle
    container_name: nexus_oracle
    ports:
      - "8100:8100"
    volumes:
      - ./data/rag:/data/rag:ro
    environment:
      - CHROMA_PATH=/data/rag/chromadb
      - OLLAMA_URL=http://nexus_ollama:11434
      - MODEL_NAME=llama3.2:3b
      - TOP_K=5
    depends_on:
      nexus_ollama:
        condition: service_started
    networks:
      - nexus_network
    mem_limit: 768m
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8100/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

volumes:
  ecosystem_api_data:

networks:
  nexus_network:
    driver: bridge
