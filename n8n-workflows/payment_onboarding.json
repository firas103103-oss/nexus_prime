{
  "name": "NEXUS Payment Onboarding",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "stripe-onboard",
        "responseMode": "responseNode",
        "options": {}
      },
      "name": "Stripe Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [250, 300]
    },
    {
      "parameters": {
        "jsCode": "// Parse Stripe event\nconst event = $input.item.json;\nconst type = event.body?.type || event.type;\nconst data = event.body?.data?.object || event.data?.object || {};\n\nlet action = 'unknown';\nlet customerEmail = '';\nlet product = '';\nlet amount = 0;\n\nif (type === 'checkout.session.completed') {\n  action = 'new_subscription';\n  customerEmail = data.customer_email || data.customer_details?.email || '';\n  product = data.metadata?.product_id || 'unknown';\n  amount = (data.amount_total || 0) / 100;\n} else if (type === 'customer.subscription.deleted') {\n  action = 'cancellation';\n  customerEmail = data.metadata?.email || '';\n  product = data.metadata?.product_id || '';\n} else if (type === 'invoice.payment_failed') {\n  action = 'payment_failed';\n  customerEmail = data.customer_email || '';\n  amount = (data.amount_due || 0) / 100;\n}\n\nreturn [{\n  json: {\n    action,\n    customerEmail,\n    product,\n    amount,\n    eventType: type,\n    timestamp: new Date().toISOString(),\n    stripeCustomerId: data.customer || '',\n    subscriptionId: data.subscription || data.id || ''\n  }\n}];"
      },
      "name": "Parse Event",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [450, 300]
    },
    {
      "parameters": {
        "rules": {
          "rules": [
            {"value": "new_subscription"},
            {"value": "cancellation"},
            {"value": "payment_failed"}
          ]
        },
        "dataType": "string",
        "value1": "={{ $json.action }}"
      },
      "name": "Route Action",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 2,
      "position": [650, 300]
    },
    {
      "parameters": {
        "jsCode": "// Auto-activate user account\nconst data = $input.item.json;\n\nconst activationPayload = {\n  email: data.customerEmail,\n  product: data.product,\n  subscription_id: data.subscriptionId,\n  stripe_customer_id: data.stripeCustomerId,\n  status: 'active',\n  activated_at: new Date().toISOString(),\n  plan_amount: data.amount\n};\n\nreturn [{\n  json: {\n    ...data,\n    activation: activationPayload,\n    welcomeEmail: {\n      to: data.customerEmail,\n      subject: `âœ… ØªÙ… ØªÙØ¹ÙŠÙ„ Ø­Ø³Ø§Ø¨Ùƒ - ${data.product}`,\n      html: `<html dir='rtl'><body style='font-family:Cairo,sans-serif;background:#0a0a0a;color:#fff;padding:40px'>\n        <div style='max-width:600px;margin:0 auto;background:#111;border-radius:16px;padding:40px;border:1px solid #22c55e'>\n          <h1 style='color:#22c55e'>âœ… Ù…Ø¨Ø±ÙˆÙƒ! ØªÙ… ØªÙØ¹ÙŠÙ„ Ø­Ø³Ø§Ø¨Ùƒ</h1>\n          <p>Ø´ÙƒØ±Ø§Ù‹ Ù„Ø§Ø´ØªØ±Ø§ÙƒÙƒ ÙÙŠ <strong style='color:#6366f1'>${data.product}</strong></p>\n          <div style='background:#0a2e1a;padding:20px;border-radius:12px;margin:20px 0'>\n            <p>ğŸ“¦ Ø§Ù„Ù…Ù†ØªØ¬: <strong>${data.product}</strong></p>\n            <p>ğŸ’° Ø§Ù„Ù…Ø¨Ù„Øº: <strong>$${data.amount}/Ø´Ù‡Ø±</strong></p>\n            <p>ğŸ”‘ Ø§Ù„Ø­Ø§Ù„Ø©: <strong style='color:#22c55e'>Ù…ÙØ¹Ù‘Ù„</strong></p>\n          </div>\n          <h3>ğŸš€ Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø¢Ù†:</h3>\n          <ol style='line-height:2.5'>\n            <li><a href='https://mrf103.com/dashboard' style='color:#6366f1'>Ø§Ø¯Ø®Ù„ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</a></li>\n            <li><a href='https://mrf103.com/docs' style='color:#6366f1'>Ø§Ù‚Ø±Ø£ Ø¯Ù„ÙŠÙ„ Ø§Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ø³Ø±ÙŠØ¹</a></li>\n            <li><a href='https://mrf103.com/support' style='color:#6366f1'>ØªÙˆØ§ØµÙ„ Ù…Ø¹ ÙØ±ÙŠÙ‚ Ø§Ù„Ø¯Ø¹Ù…</a></li>\n          </ol>\n        </div></body></html>`\n    }\n  }\n}];"
      },
      "name": "Activate Account",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [900, 150]
    },
    {
      "parameters": {
        "url": "http://localhost:8001/api/v1/accounts/activate",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {"name": "email", "value": "={{ $json.activation.email }}"},
            {"name": "product", "value": "={{ $json.activation.product }}"},
            {"name": "subscription_id", "value": "={{ $json.activation.subscription_id }}"},
            {"name": "stripe_customer_id", "value": "={{ $json.activation.stripe_customer_id }}"},
            {"name": "status", "value": "active"}
          ]
        },
        "options": {}
      },
      "name": "Save Activation",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 3,
      "position": [1150, 150]
    },
    {
      "parameters": {
        "jsCode": "// Handle cancellation\nconst data = $input.item.json;\n\nreturn [{\n  json: {\n    ...data,\n    deactivation: {\n      email: data.customerEmail,\n      product: data.product,\n      subscription_id: data.subscriptionId,\n      status: 'cancelled',\n      cancelled_at: new Date().toISOString()\n    },\n    cancellationEmail: {\n      to: data.customerEmail,\n      subject: 'ğŸ˜¢ Ù†Ø£Ø³Ù Ù„Ø±Ø­ÙŠÙ„Ùƒ - NEXUS PRIME',\n      html: `<html dir='rtl'><body style='font-family:Cairo,sans-serif;background:#0a0a0a;color:#fff;padding:40px'>\n        <div style='max-width:600px;margin:0 auto;background:#111;border-radius:16px;padding:40px;border:1px solid #f59e0b'>\n          <h1 style='color:#f59e0b'>ğŸ˜¢ Ù†Ø£Ø³Ù Ù„Ø¥Ù„ØºØ§Ø¡ Ø§Ø´ØªØ±Ø§ÙƒÙƒ</h1>\n          <p>ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ø´ØªØ±Ø§ÙƒÙƒ ÙÙŠ <strong>${data.product}</strong></p>\n          <div style='background:linear-gradient(135deg,#6366f1,#8b5cf6);padding:25px;border-radius:12px;margin:20px 0;text-align:center'>\n            <h2 style='margin:0'>Ø¹Ø±Ø¶ Ø®Ø§Øµ Ù„Ù„Ø¹ÙˆØ¯Ø©!</h2>\n            <p>Ø®ØµÙ… 40% Ù„Ù…Ø¯Ø© 3 Ø£Ø´Ù‡Ø±</p>\n            <p>Ø§Ù„ÙƒÙˆØ¯: <strong>COMEBACK40</strong></p>\n          </div>\n          <a href='https://mrf103.com/#pricing' style='display:inline-block;background:#f59e0b;color:black;padding:15px 40px;border-radius:12px;text-decoration:none;font-weight:bold'>Ø£Ø¹Ø¯ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ø¨Ø®ØµÙ… 40% â†’</a>\n        </div></body></html>`\n    }\n  }\n}];"
      },
      "name": "Handle Cancel",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [900, 300]
    },
    {
      "parameters": {
        "jsCode": "// Handle failed payment\nconst data = $input.item.json;\n\nreturn [{\n  json: {\n    ...data,\n    retryEmail: {\n      to: data.customerEmail,\n      subject: 'âš ï¸ ÙØ´Ù„ Ø§Ù„Ø¯ÙØ¹ - ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©',\n      html: `<html dir='rtl'><body style='font-family:Cairo,sans-serif;background:#0a0a0a;color:#fff;padding:40px'>\n        <div style='max-width:600px;margin:0 auto;background:#111;border-radius:16px;padding:40px;border:1px solid #ef4444'>\n          <h1 style='color:#ef4444'>âš ï¸ ÙØ´Ù„ Ø§Ù„Ø¯ÙØ¹</h1>\n          <p>Ù„Ù… Ù†ØªÙ…ÙƒÙ† Ù…Ù† ØªØ­ØµÙŠÙ„ Ù…Ø¨Ù„Øº <strong>$${data.amount}</strong></p>\n          <p>ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø·Ø§Ù‚ØªÙƒ Ù„ØªØ¬Ù†Ø¨ Ø§Ù†Ù‚Ø·Ø§Ø¹ Ø§Ù„Ø®Ø¯Ù…Ø©</p>\n          <div style='background:#1a0a0a;padding:15px;border-radius:8px;margin:15px 0'>\n            <p>â° Ù„Ø¯ÙŠÙƒ 72 Ø³Ø§Ø¹Ø© Ù‚Ø¨Ù„ ØªØ¹Ù„ÙŠÙ‚ Ø§Ù„Ø­Ø³Ø§Ø¨</p>\n          </div>\n          <a href='https://mrf103.com/billing' style='display:inline-block;background:#ef4444;color:white;padding:15px 40px;border-radius:12px;text-decoration:none;font-weight:bold'>ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯ÙØ¹ â†’</a>\n        </div></body></html>`\n    }\n  }\n}];"
      },
      "name": "Handle Failed",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [900, 450]
    },
    {
      "parameters": {
        "url": "https://hooks.slack.com/services/YOUR_SLACK_WEBHOOK",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "text",
              "value": "={{ $json.action === 'new_subscription' ? 'ğŸ’° NEW SALE!' : $json.action === 'cancellation' ? 'ğŸ˜¢ Cancellation' : 'âš ï¸ Payment Failed' }}\nğŸ“§ {{ $json.customerEmail }}\nğŸ“¦ {{ $json.product }}\nğŸ’µ ${{ $json.amount }}"
            }
          ]
        },
        "options": {}
      },
      "name": "Notify Revenue",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 3,
      "position": [1350, 300]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={\"received\": true}"
      },
      "name": "Respond OK",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [1550, 300]
    }
  ],
  "connections": {
    "Stripe Webhook": {
      "main": [
        [{"node": "Parse Event", "type": "main", "index": 0}]
      ]
    },
    "Parse Event": {
      "main": [
        [{"node": "Route Action", "type": "main", "index": 0}]
      ]
    },
    "Route Action": {
      "main": [
        [{"node": "Activate Account", "type": "main", "index": 0}],
        [{"node": "Handle Cancel", "type": "main", "index": 0}],
        [{"node": "Handle Failed", "type": "main", "index": 0}]
      ]
    },
    "Activate Account": {
      "main": [
        [{"node": "Save Activation", "type": "main", "index": 0}]
      ]
    },
    "Save Activation": {
      "main": [
        [{"node": "Notify Revenue", "type": "main", "index": 0}]
      ]
    },
    "Handle Cancel": {
      "main": [
        [{"node": "Notify Revenue", "type": "main", "index": 0}]
      ]
    },
    "Handle Failed": {
      "main": [
        [{"node": "Notify Revenue", "type": "main", "index": 0}]
      ]
    },
    "Notify Revenue": {
      "main": [
        [{"node": "Respond OK", "type": "main", "index": 0}]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "tags": [{"name": "payments"}, {"name": "onboarding"}, {"name": "stripe"}]
}
